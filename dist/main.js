(()=>{"use strict";class e{constructor(){this.sidebar=null,this.toggleButton=null,this.activeSection=null}initializeSidebar(){let e=document.getElementById("gemini-organizer-sidebar");return e||(e=document.createElement("div"),e.id="gemini-organizer-sidebar",e.classList.add("hidden"),e.innerHTML='\n                <div class="sidebar-actions">\n                    <div class="action-buttons-group">\n                        <button id="create-folder-section-btn" class="sidebar-action-btn">\n                            <mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="create_new_folder" fonticon="add"></mat-icon>\n                            <span>Carpeta</span>\n                        </button>\n                        <button id="search-section-btn" class="sidebar-action-btn">\n                            <mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="search" fonticon="search"></mat-icon>\n                            <span>Buscar</span>\n                        </button>\n                    </div>\n                    <button id="open-options-btn" class="settings-btn" title="Abrir configuraci贸n">\n                        <mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="settings" fonticon="settings"></mat-icon>\n                    </button>\n                </div>\n                <div id="create-folder-container" class="collapsible-section hidden">\n                    <div class="folder-controls">\n                        <h4>Crear Nueva Carpeta</h4>\n                        <div class="input-with-button-wrapper">\n                            <input type="text" id="new-folder-name" placeholder="Mi carpeta...">\n                            <button id="create-folder-btn" title="Crear Carpeta">\n                                <mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="add" fonticon="add"></mat-icon>\n                            </button>\n                        </div>\n                        </div>\n                </div>\n                <div id="search-conversations-container" class="collapsible-section hidden">\n                    <div class="search-controls">\n                        <h4>Buscar Conversaciones</h4>\n                        <div class="input-with-button-wrapper">\n                            <mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="search" fonticon="search"></mat-icon>\n                            <input type="search" id="search-conversations-input" placeholder="Buscar en tus carpetas...">\n                        </div>\n                        </div>\n                </div>\n                <div class="folders-list">\n                    <div class="folders-list-header">\n                        <h4 class="title gds-label-l">Tus Carpetas Guardadas</h4>\n                        <span id="sync-status-icon" class="sync-status-indicator"></span>\n                    </div>\n                    <ul id="folders-list-ul"></ul>\n                </div>\n            '),this.sidebar=e,e}updateSyncStatusIcon(e){const t=document.getElementById("sync-status-icon");t&&(e?(t.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="cloud" fonticon="cloud"></mat-icon>',t.title="Carpetas sincronizadas con tu cuenta de Google."):(t.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="cloud_off" fonticon="cloud_off"></mat-icon>',t.title="Carpetas guardadas localmente en este dispositivo."))}addToggleButton(e,t){const a=document.querySelector('side-nav-action-button[data-test-id="manage-instructions-control"]');if(a){let n=document.getElementById("gemini-organizer-wrapper");if(!n){n=document.createElement("side-nav-action-button"),n.id="gemini-organizer-wrapper",n.setAttribute("icon","folder_open"),n.setAttribute("arialabel","Organizador de Conversaciones"),n.setAttribute("data-test-id","gemini-organizer-button"),n.classList.add("mat-mdc-tooltip-trigger","ia-redesign","ng-star-inserted");const e=document.createElement("button");e.id="gemini-organizer-toggle-btn",e.classList.add("mat-mdc-list-item","mdc-list-item","side-nav-action-button","explicit-gmat-override","mat-mdc-list-item-interactive","mdc-list-item--with-leading-icon","mat-mdc-list-item-single-line","mdc-list-item--with-one-line","ng-star-inserted"),e.type="button",e.setAttribute("aria-label","Organizador de Conversaciones"),e.setAttribute("aria-disabled","false"),e.innerHTML='\n                    <div matlistitemicon="" class="mat-mdc-list-item-icon icon-container mdc-list-item__start" style="margin-left: 0px;margin-right: 0px;">\n                        <mat-icon role="img" class="mat-icon notranslate gds-icon-l google-symbols mat-ligature-font mat-icon-no-color ng-star-inserted" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="folder_open" fonticon="folder_open"></mat-icon>\n                    </div>\n                    <span class="mdc-list-item__content">\n                        <span class="mat-mdc-list-item-unscoped-content mdc-list-item__primary-text">\n                            <span data-test-id="side-nav-action-button-content" class="gds-body-m">Mis conversaciones</span>\n                        </span>\n                    </span>\n                    <div class="mat-focus-indicator"></div>\n                ',n.appendChild(e),a.after(n),this.toggleButton=e,t&&t.loadAndDisplayFolders()}this.sidebar||this.initializeSidebar(),this.sidebar&&!n.contains(this.sidebar)&&n.appendChild(this.sidebar),e.addEventListeners()}}toggleSidebarVisibility(){this.sidebar&&(this.sidebar.classList.toggle("hidden"),this.sidebar.classList.contains("hidden")&&this.toggleSectionVisibility(null))}toggleSectionVisibility(e){const t=document.getElementById("create-folder-container"),a=document.getElementById("search-conversations-container"),n=document.getElementById("create-folder-section-btn"),o=document.getElementById("search-section-btn");this.activeSection===e&&(e=null),this.activeSection=e,t&&a&&(t.classList.toggle("hidden","create-folder-container"!==e),a.classList.toggle("hidden","search-conversations-container"!==e)),n&&o&&(n.classList.toggle("active","create-folder-container"===e),o.classList.toggle("active","search-conversations-container"===e))}renderFolders(e,t,a,n){const o=document.getElementById("folders-list-ul");if(!o)return;o.innerHTML="";const s=Object.keys(e).sort();for(const i of s){const s=e[i],r=this.createFolderElement(i,s,t,a,n);o.appendChild(r)}}createFolderElement(e,t,a,n,o){const s=document.createElement("li");s.classList.add("gemini-folder-item");const i=this.createFolderHeader(e,o),r=this.createConversationsWrapper(e,t,n,o);s.appendChild(i),s.appendChild(r);const[d,l,c,g]=i.children;return n.addFolderInteractionListeners(i,r,g,l,c,e,d),a[e]?(r.classList.remove("hidden"),g.setAttribute("fonticon","expand_less"),g.setAttribute("data-mat-icon-name","expand_less")):(r.classList.add("hidden"),g.setAttribute("fonticon","expand_more"),g.setAttribute("data-mat-icon-name","expand_more")),s}createFolderHeader(e,t){const a=document.createElement("div");return a.classList.add("title-container"),a.setAttribute("role","button"),a.setAttribute("tabindex","0"),a.dataset.folderName=e,a.addEventListener("dragover",t.handleDragOver.bind(t)),a.addEventListener("dragleave",t.handleDragLeave.bind(t)),a.addEventListener("drop",t.handleDrop.bind(t)),a.innerHTML=`\n            <span class="title gds-label-l gemini-folder-title" data-folder-name="${e}">${e}</span>\n            <button class="edit-folder-btn" title="Renombrar carpeta: &quot;${e}&quot;" data-folder-name="${e}"><mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="edit" fonticon="edit"></mat-icon></button>\n            <button class="delete-folder-btn" title="Eliminar carpeta: &quot;${e}&quot;" data-folder-name="${e}"><mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="delete" fonticon="delete"></mat-icon></button>\n            <mat-icon role="img" class="mat-icon notranslate gds-icon-l google-symbols mat-ligature-font mat-icon-no-color gemini-expand-icon" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="expand_more" fonticon="expand_more"></mat-icon>\n        `,a}createConversationsWrapper(e,t,a,n){const o=document.createElement("div");o.classList.add("conversations-list-wrapper");const s=document.createElement("ul");return s.classList.add("conversation-items-container","side-nav-opened"),s.dataset.folderName=e,s.addEventListener("dragover",n.handleConversationListDragOver.bind(n)),s.addEventListener("drop",n.handleConversationListDrop.bind(n)),t.forEach((t,o)=>{const i=this.createConversationElement(t,e,o,a,n);s.appendChild(i)}),o.appendChild(s),o}createConversationElement(e,t,a,n,o){const s=document.createElement("li");return s.classList.add("conversation-item-wrapper"),s.setAttribute("draggable","true"),s.dataset.folderName=t,s.dataset.convId=e.id,s.dataset.convTitle=e.title,s.dataset.convUrl=e.url,s.dataset.originalIndex=a,s.addEventListener("dragstart",o.handleDragStart.bind(o)),s.addEventListener("dragend",e=>e.target.classList.remove("is-dragging")),s.innerHTML=`\n            <div class="conversation-item-content">\n                <div class="conversation-title gds-body-m" data-folder-name="${t}" data-conv-id="${e.id}" style="flex-grow: 1; cursor: pointer;" title="${e.title}">${e.title}</div>\n                <button class="delete-conversation-btn" title="Eliminar conversaci贸n: &quot;${e.title}&quot;" data-folder-name="${t}" data-conv-id="${e.id}"><mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="delete" fonticon="delete"></mat-icon></button>\n            </div>\n        `,n.addConversationListeners(s),s}enableFolderEditMode(e,t,a,n,o,s){const i=e;t.style.display="none",a.style.display="none",n.style.display="none",o.style.display="none";const r=document.createElement("input");r.type="text",r.value=i,r.classList.add("folder-rename-input"),r.dataset.originalFolderName=i,t.parentNode.insertBefore(r,t),r.focus(),r.select(),s.addFolderRenameListeners(r,i,t,a,n,o)}openGeminiChat(e){const t=e.target.dataset.convId;if(t){const e='.chat-history-list .conversation[jslog*="\\"c_'+t+'\\""]',a=document.querySelector(e);if(a){const e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0,buttons:1}),t=new MouseEvent("mousedown",{view:window,bubbles:!0,cancelable:!0,buttons:1}),n=new MouseEvent("mouseup",{view:window,bubbles:!0,cancelable:!0});a.dispatchEvent(t),a.dispatchEvent(n),a.dispatchEvent(e),setTimeout(()=>{this.sidebar.classList.add("hidden")},100)}else showToast("No se pudo cargar la conversaci贸n r谩pidamente. Recargando p谩gina...","info"),window.location.href=`https://gemini.google.com/app/${t}`,this.sidebar.classList.add("hidden")}else showToast("No se pudo encontrar el ID de esta conversaci贸n.","error")}filterConversationsAndFolders(){const e=document.getElementById("search-conversations-input").value.toLowerCase().trim();document.getElementById("folders-list-ul").querySelectorAll(".gemini-folder-item").forEach(t=>{const a=t.querySelector(".gemini-folder-title").textContent.toLowerCase(),n=t.querySelector(".conversations-list-wrapper"),o=n.querySelectorAll(".conversation-item-wrapper"),s=t.querySelector(".gemini-expand-icon");let i=a.includes(e),r=!1;if(o.forEach(t=>{t.querySelector(".conversation-title").textContent.toLowerCase().includes(e)?(t.style.display="",r=!0):t.style.display="none"}),""===e)return t.style.display="",n.classList.add("hidden"),s.setAttribute("fonticon","expand_more"),s.setAttribute("data-mat-icon-name","expand_more"),void o.forEach(e=>e.style.display="");i||r?(t.style.display="",n.classList.remove("hidden"),s.setAttribute("fonticon","expand_less"),s.setAttribute("data-mat-icon-name","expand_less")):t.style.display="none"})}}class t{constructor(e){this.key=e,this.storageArea=null}async setStorageArea(e){return this.storageArea="sync"===e?chrome.storage.sync:chrome.storage.local,console.log("rea de almacenamiento establecida en: "+(this.storageArea===chrome.storage.sync?"sync":"local")),this}async getFolders(){return(await this.storageArea.get(this.key))[this.key]||{}}async saveFolders(e){return this.storageArea.set({[this.key]:e})}async getSyncEnabled(){return(await chrome.storage.sync.get("syncEnabled")).syncEnabled||!1}async setSyncEnabled(e){return chrome.storage.sync.set({syncEnabled:e})}}class a{constructor(e,t){this.storage=e,this.ui=t}async loadAndDisplayFolders(){const e=this.getOpenFolderStates(),t=await this.storage.getFolders();this.ui.renderFolders(t,e,this.eventHandler,this.dragAndDropHandler)}async createFolder(){const e=document.getElementById("new-folder-name"),t=e.value.trim();if(t){const a=await this.storage.getFolders();a[t]?showToast(`La carpeta "${t}" ya existe.`,"warning"):(a[t]=[],await this.storage.saveFolders(a),e.value="",this.loadAndDisplayFolders(),showToast(`Carpeta "${t}" creada exitosamente.`,"success"))}else showToast("Por favor, ingresa un nombre para la carpeta.","warning")}async saveFolderRename(e,t,a,n,o,s){const i=e.value.trim();if(!e.parentNode)return;if(i===t)return e.remove(),a.style.display="block",n.style.display="block",o.style.display="block",void(s.style.display="block");if(!i)return showToast("El nombre de la carpeta no puede estar vac铆o. Se restaurar谩 el nombre original.","warning"),e.remove(),a.style.display="block",n.style.display="block",o.style.display="block",void(s.style.display="block");const r=await this.storage.getFolders();if(r[i]&&i!==t)return showToast(`Ya existe una carpeta con el nombre "${i}". Por favor, elige un nombre diferente.`,"warning"),e.remove(),a.style.display="block",n.style.display="block",o.style.display="block",void(s.style.display="block");const d=r[t];delete r[t],r[i]=d,await this.storage.saveFolders(r),showToast(`Carpeta "${t}" renombrada a "${i}" exitosamente.`,"success"),e.remove(),this.loadAndDisplayFolders()}async deleteFolder(e){e.stopPropagation();const t=e.currentTarget.dataset.folderName;if(!t)return void showToast("Hubo un error al intentar eliminar la carpeta.","error");if(!confirm(`驴Est谩s seguro de que quieres eliminar la carpeta "${t}"?`))return;const a=await this.storage.getFolders();a[t]?(delete a[t],await this.storage.saveFolders(a),showToast(`Carpeta "${t}" eliminada.`,"success"),this.loadAndDisplayFolders()):showToast("La carpeta especificada no existe.","error")}async deleteConversation(e){if(!confirm("驴Est谩s seguro de que quieres eliminar esta conversaci贸n?"))return;const t=e.currentTarget.dataset.folderName,a=e.currentTarget.dataset.convId;if(!t||!a)return void showToast("Hubo un error al intentar eliminar la conversaci贸n.","error");const n=await this.storage.getFolders();n[t]?(n[t]=n[t].filter(e=>e.id!==a),await this.storage.saveFolders(n),showToast("Conversaci贸n eliminada.","success"),this.loadAndDisplayFolders()):showToast("La carpeta especificada no existe.","error")}getOpenFolderStates(){const e={},t=document.getElementById("folders-list-ul");return t&&t.querySelectorAll(".gemini-folder-item").forEach(t=>{const a=t.querySelector(".gemini-folder-title").dataset.folderName,n=t.querySelector(".conversations-list-wrapper");n&&!n.classList.contains("hidden")&&(e[a]=!0)}),e}async saveCurrentConversation(e){const t=window.location.href,a=extractRealConversationIdFromCurrentUrl(),n=extractConversationTitle();if(!a||!n)return void showToast("No se pudo obtener la informaci贸n de la conversaci贸n actual.","error");const o=await this.storage.getFolders();o[e]?o[e].find(e=>e.id===a)?showToast("Esta conversaci贸n ya est谩 guardada en esta carpeta.","info"):(o[e].push({id:a,title:n,url:t,timestamp:(new Date).toLocaleString()}),await this.storage.saveFolders(o),showToast(`Conversaci贸n guardada en la carpeta "${e}".`,"success"),this.loadAndDisplayFolders()):showToast(`La carpeta "${e}" no existe.`,"error")}setEventHandler(e){this.eventHandler=e}setDragAndDropHandler(e){this.dragAndDropHandler=e}}class n{constructor(e,t){this.storage=e,this.folderManager=t}handleDragStart(e){const t=e.target.closest('.chat-history-list .conversation[data-test-id="conversation"]'),a=e.target.closest('.conversation-item-wrapper[draggable="true"]');let n;if(t){const e=t.querySelector(".conversation-title"),a=e?e.textContent.trim():"Conversaci贸n sin t铆tulo";let o=null,s="";const i=t.getAttribute("jslog");if(i){const e=i.match(/BardVeMetadataKey:\[[^\]]*\x22c_([^\x22]+)\x22/);e&&e[1]&&(o=e[1],s=`https://gemini.google.com/app/${o}`)}!o&&t.classList.contains("selected")&&(o=extractRealConversationIdFromCurrentUrl(),o&&(s=`https://gemini.google.com/app/${o}`)),o||(o="fallback_"+Date.now().toString()),n={id:o,title:a,url:s||window.location.href,folder_from:null,original_index:-1},t.classList.add("is-dragging")}else{if(!a)return void e.preventDefault();n={id:a.dataset.convId,title:a.dataset.convTitle,url:a.dataset.convUrl,folder_from:a.dataset.folderName,original_index:parseInt(a.dataset.originalIndex)},a.classList.add("is-dragging")}e.dataTransfer.setData("application/json",JSON.stringify(n)),e.dataTransfer.effectAllowed="move"}handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move",e.currentTarget&&e.currentTarget.classList.contains("title-container")&&e.currentTarget.classList.add("drag-over")}handleDragLeave(e){e.currentTarget&&e.currentTarget.classList.contains("title-container")&&e.currentTarget.classList.remove("drag-over"),e.currentTarget.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(e=>{e.classList.remove("drag-over-top","drag-over-bottom")})}async handleDrop(e){e.preventDefault(),e.currentTarget&&e.currentTarget.classList.contains("title-container")&&e.currentTarget.classList.remove("drag-over");const t=e.dataTransfer.getData("application/json");if(!t)return;const a=JSON.parse(t),n=e.currentTarget.dataset.folderName,o=a.folder_from;if(!n)return;const s=await this.storage.getFolders();o&&o!==n&&(s[o]=s[o].filter(e=>e.id!==a.id)),s[n].some(e=>e.id===a.id)||s[n].push({id:a.id,title:a.title,url:a.url,timestamp:(new Date).toLocaleString()}),await this.storage.saveFolders(s),this.folderManager.loadAndDisplayFolders(),showToast(`Conversaci贸n movida a "${n}"`,"success")}handleConversationListDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest(".conversation-item-wrapper"),a=e.currentTarget;if(a.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(e=>e.classList.remove("drag-over-top","drag-over-bottom")),t){const a=t.getBoundingClientRect();e.clientY-a.top<a.height/2?t.classList.add("drag-over-top"):t.classList.add("drag-over-bottom")}else a.classList.add("drag-over-bottom")}async handleConversationListDrop(e){e.preventDefault(),e.currentTarget.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(e=>e.classList.remove("drag-over-top","drag-over-bottom"));const t=e.dataTransfer.getData("application/json");if(!t)return;const a=JSON.parse(t),n=e.currentTarget.dataset.folderName,o=a.folder_from,s=a.original_index;if(!n)return;const i=await this.storage.getFolders(),r=e.target.closest(".conversation-item-wrapper");let d;if(r){const t=r.getBoundingClientRect(),a=e.clientY-t.top,n=Array.from(r.parentNode.children).indexOf(r);d=a<t.height/2?n:n+1}else d=i[n].length;if(o===n){const[e]=i[n].splice(s,1);i[n].splice(d>s?d-1:d,0,e)}else o&&(i[o]=i[o].filter(e=>e.id!==a.id)),i[n].some(e=>e.id===a.id)||i[n].splice(d,0,{id:a.id,title:a.title,url:a.url,timestamp:(new Date).toLocaleString()});await this.storage.saveFolders(i),this.folderManager.loadAndDisplayFolders(),showToast("Conversaci贸n reordenada","success")}async setupDraggableConversations(){const e=document.querySelectorAll('.chat-history-list .conversation[data-test-id="conversation"]'),t=await this.storage.getFolders(),a=new Set;for(const e in t)t[e].forEach(e=>a.add(e.id));e.forEach(e=>{e.hasAttribute("data-draggable-setup")||(e.setAttribute("draggable","true"),e.addEventListener("dragstart",this.handleDragStart.bind(this)),e.addEventListener("dragend",e=>e.target.classList.remove("is-dragging")),e.setAttribute("data-draggable-setup","true"));const t=e.getAttribute("jslog");let n=null;if(t){const e=t.match(/BardVeMetadataKey:\[[^\]]*\x22c_([^\x22]+)\x22/);e&&e[1]&&(n=e[1])}const o=e.querySelector(".conversation-title");if(n&&a.has(n)){e.classList.add("is-saved");let t=o.querySelector(".gemini-organizer-saved-icon");t||(t=document.createElement("span"),t.classList.add("gemini-organizer-saved-icon"),t.textContent="",o.insertBefore(t,o.firstChild))}else{e.classList.remove("is-saved");const t=o.querySelector(".gemini-organizer-saved-icon");t&&t.remove()}})}}class o{constructor(e,t,a){this.ui=e,this.folderManager=t,this.dragAndDropHandler=a}addEventListeners(){const e=document.getElementById("create-folder-section-btn");e&&e.addEventListener("click",()=>this.ui.toggleSectionVisibility("create-folder-container"));const t=document.getElementById("search-section-btn");t&&t.addEventListener("click",()=>this.ui.toggleSectionVisibility("search-conversations-container"));const a=document.getElementById("create-folder-btn");a&&a.addEventListener("click",this.folderManager.createFolder.bind(this.folderManager));const n=document.getElementById("search-conversations-input");n&&n.addEventListener("input",this.ui.filterConversationsAndFolders.bind(this.ui)),this.ui.toggleButton&&this.ui.toggleButton.addEventListener("click",this.ui.toggleSidebarVisibility.bind(this.ui))}addFolderInteractionListeners(e,t,a,n,o,s,i){e.addEventListener("click",()=>{t.classList.toggle("hidden");const e=t.classList.contains("hidden");a.setAttribute("fonticon",e?"expand_more":"expand_less"),a.setAttribute("data-mat-icon-name",e?"expand_more":"expand_less")}),n.addEventListener("click",e=>{e.stopPropagation(),this.ui.enableFolderEditMode(s,i,o,n,a,this)}),o.addEventListener("click",this.folderManager.deleteFolder.bind(this.folderManager))}addFolderRenameListeners(e,t,a,n,o,s){e.addEventListener("keypress",i=>{"Enter"===i.key&&this.folderManager.saveFolderRename(e,t,a,n,o,s)}),e.addEventListener("blur",()=>{this.folderManager.saveFolderRename(e,t,a,n,o,s)})}addConversationListeners(e){const t=e.querySelector(".conversation-title");t&&t.addEventListener("click",this.ui.openGeminiChat.bind(this.ui));const a=e.querySelector(".delete-conversation-btn");a&&a.addEventListener("click",this.folderManager.deleteConversation.bind(this.folderManager))}}(new class{constructor(){this.ui=new e,this.storage=new t("geminiConversations"),this.folderManager=new a(this.storage,this.ui),this.dragAndDropHandler=new n(this.storage,this.folderManager),this.eventHandler=new o(this.ui,this.folderManager,this.dragAndDropHandler),this.folderManager.setEventHandler(this.eventHandler),this.folderManager.setDragAndDropHandler(this.dragAndDropHandler),this.observer=new MutationObserver(this.handleMutations.bind(this)),chrome.storage.onChanged.addListener(this.handleStorageChange.bind(this)),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this))}async init(){if(!document.getElementById("gemini-organizer-toast-container")){const e=document.createElement("div");e.id="gemini-organizer-toast-container",document.body.appendChild(e)}await this.initializeSync(),window.requestIdleCallback(()=>{this.ui.addToggleButton(this.eventHandler,this.folderManager),this.dragAndDropHandler.setupDraggableConversations(),this.observer.observe(document.body,{childList:!0,subtree:!0})})}async initializeSync(){const e=await this.storage.getSyncEnabled();this.ui.updateSyncStatusIcon(e),await this.storage.setStorageArea(e?"sync":"local"),await this.folderManager.loadAndDisplayFolders(),setTimeout(()=>{const e=document.getElementById("open-options-btn");e&&e.addEventListener("click",()=>{chrome.runtime.sendMessage({action:"openOptionsPage"})})},500)}handleMutations(){const e=document.getElementById("gemini-organizer-wrapper");e&&document.body.contains(e)||(this.ui.addToggleButton(this.eventHandler,this.folderManager),this.initializeSync()),this.dragAndDropHandler.setupDraggableConversations()}handleStorageChange(e,t){"sync"===t&&(e.syncEnabled||e[this.storage.key])?(console.log("La configuraci贸n de Sync ha cambiado. Recargando la extensi贸n..."),this.initializeSync()):"local"===t&&e[this.storage.key]&&(console.log("El almacenamiento local ha cambiado. Recargando las carpetas."),this.folderManager.loadAndDisplayFolders())}handleMessage(e,t,a){"save_current_conversation_to_folder"===e.action&&this.folderManager.saveCurrentConversation(e.folderName)}}).init()})();