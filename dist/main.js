(()=>{"use strict";function e(e,t="info",n=3e3){const a=document.getElementById("gemini-organizer-toast-container");if(!a)return void console.error("Contenedor de toast no encontrado.");const i=document.createElement("div");i.classList.add("gemini-organizer-toast",`gemini-organizer-toast-${t}`),i.textContent=e,a.appendChild(i),i.offsetHeight,i.classList.add("show"),setTimeout(()=>{i.classList.remove("show"),i.addEventListener("transitionend",()=>{i.parentNode&&i.parentNode.removeChild(i)},{once:!0})},n)}function t(){try{const e=new URL(window.location.href).pathname.split("/"),t=e.pop()||e.pop();return t&&t.length>15?t:null}catch(e){return null}}class n{constructor(e={}){this.props=e,this.state={},this.element=null}setState(e){this.state={...this.state,...e},this.update()}render(){throw new Error("Component.render() must be implemented")}create(){const e=this.render(),t=document.createElement("div");return t.innerHTML=e.trim(),this.element=t.firstElementChild,this.afterRender(),this.element}afterRender(){}update(){if(!this.element||!this.element.parentNode)return void this.create();const e=this.element,t=this.create();e.parentNode.replaceChild(t,e),this.element=t}mount(e){const t=this.create();e.appendChild(t)}}class a extends n{constructor(){super(),this.activeSection=null}render(){return'\n            <div id="gemini-organizer-sidebar" class="hidden">\n                <div class="sidebar-actions">\n                    <div class="action-buttons-group">\n                        <button id="create-folder-section-btn" class="sidebar-action-btn">\n                            <mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="create_new_folder" fonticon="add"></mat-icon>\n                            <span>Carpeta</span>\n                        </button>\n                        <button id="search-section-btn" class="sidebar-action-btn">\n                            <mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="search" fonticon="search"></mat-icon>\n                            <span>Buscar</span>\n                        </button>\n                    </div>\n                    <button id="open-options-btn" class="settings-btn" title="Abrir configuraci贸n">\n                        <mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="settings" fonticon="settings"></mat-icon>\n                    </button>\n                </div>\n                <div id="create-folder-container" class="collapsible-section hidden">\n                    <div class="folder-controls">\n                        <h4>Crear Nueva Carpeta</h4>\n                        <div class="input-with-button-wrapper">\n                            <input type="text" id="new-folder-name" placeholder="Mi carpeta...">\n                            <button id="create-folder-btn" title="Crear Carpeta">\n                                <mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="add" fonticon="add"></mat-icon>\n                            </button>\n                        </div>\n                    </div>\n                </div>\n                <div id="search-conversations-container" class="collapsible-section hidden">\n                    <div class="search-controls">\n                        <h4>Buscar Conversaciones</h4>\n                        <div class="input-with-button-wrapper">\n                            <mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="search" fonticon="search"></mat-icon>\n                            <input type="search" id="search-conversations-input" placeholder="Buscar en tus carpetas...">\n                        </div>\n                    </div>\n                </div>\n                <div class="folders-list">\n                    <div class="folders-list-header">\n                        <h4 class="title gds-label-l">Tus Carpetas Guardadas</h4>\n                        <span id="sync-status-icon" class="sync-status-indicator"></span>\n                    </div>\n                    <ul id="folders-list-ul"></ul>\n                </div>\n            </div>\n        '}initialize(){return this.element||this.create(),this.element}toggleVisibility(){this.element&&(this.element.classList.toggle("hidden"),this.element.classList.contains("hidden")&&this.toggleSectionVisibility(null))}toggleSectionVisibility(e){const t=document.getElementById("create-folder-container"),n=document.getElementById("search-conversations-container"),a=document.getElementById("create-folder-section-btn"),i=document.getElementById("search-section-btn");this.activeSection===e&&(e=null),this.activeSection=e,t&&n&&(t.classList.toggle("hidden","create-folder-container"!==e),n.classList.toggle("hidden","search-conversations-container"!==e)),a&&i&&(a.classList.toggle("active","create-folder-container"===e),i.classList.toggle("active","search-conversations-container"===e))}updateSyncStatusIcon(e){const t=document.getElementById("sync-status-icon");t&&(e?(t.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="cloud" fonticon="cloud"></mat-icon>',t.title="Carpetas sincronizadas con tu cuenta de Google."):(t.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="cloud_off" fonticon="cloud_off"></mat-icon>',t.title="Carpetas guardadas localmente en este dispositivo."))}hide(){this.element&&this.element.classList.add("hidden")}}class i extends n{constructor(e){super(e),this.openChat=this.openChat.bind(this)}render(){const{folderName:e,conversations:t}=this.props;return`\n            <div class="conversations-list-wrapper">\n                <ul class="conversation-items-container side-nav-opened" data-folder-name="${e}">\n                    ${t.map((t,n)=>`\n            <li class="conversation-item-wrapper" draggable="true" \n                data-folder-name="${e}" \n                data-conv-id="${t.id}" \n                data-conv-title="${t.title}" \n                data-conv-url="${t.url}" \n                data-original-index="${n}">\n                <div class="conversation-item-content">\n                    <div class="conversation-title gds-body-m" data-folder-name="${e}" data-conv-id="${t.id}" style="flex-grow: 1; cursor: pointer;" title="${t.title}">${t.title}</div>\n                    <button class="delete-conversation-btn" title="Eliminar conversaci贸n: &quot;${t.title}&quot;" data-folder-name="${e}" data-conv-id="${t.id}"><mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="delete" fonticon="delete"></mat-icon></button>\n                </div>\n            </li>\n        `).join("")}\n                </ul>\n            </div>\n        `}afterRender(){const{eventHandler:e,dragAndDropHandler:t}=this.props,n=this.element.querySelector("ul");t&&n&&(n.addEventListener("dragover",t.handleConversationListDragOver.bind(t)),n.addEventListener("drop",t.handleConversationListDrop.bind(t))),this.element.querySelectorAll(".conversation-item-wrapper").forEach(n=>{t&&(n.addEventListener("dragstart",t.handleDragStart.bind(t)),n.addEventListener("dragend",e=>e.target.classList.remove("is-dragging"))),e&&e.addConversationListeners(n)})}async openChat(t,n){if(t){const a='.chat-history-list .conversation[jslog*="\\"c_'+t+'\\""]';let i=document.querySelector(a);if(i||(await new Promise(e=>setTimeout(e,500)),i=document.querySelector(a)),i){const e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0,buttons:1}),t=new MouseEvent("mousedown",{view:window,bubbles:!0,cancelable:!0,buttons:1}),a=new MouseEvent("mouseup",{view:window,bubbles:!0,cancelable:!0});i.dispatchEvent(t),i.dispatchEvent(a),i.dispatchEvent(e),setTimeout(()=>{n&&n.hide()},100)}else console.warn(`Gemini Organizer: Could not find conversation element for ID ${t}. Fallback to page reload.`),e("Conversaci贸n no encontrada en la lista reciente. Recargando para buscarla...","warning"),window.location.href=`https://gemini.google.com/app/${t}`,n&&n.hide()}else e("No se pudo encontrar el ID de esta conversaci贸n.","error")}}class o extends n{constructor(e){super(e),this.conversationList=new i({})}render(){return'<ul id="folders-list-ul"></ul>'}async afterRender(){}async renderFolders(e,t,n,a){let i=document.getElementById("folders-list-ul");if(!i)return;if(i.innerHTML="",!e||0===Object.keys(e).length)return void(i.innerHTML='\n                <div class="empty-state-container">\n                    <div class="empty-state-icon-wrapper">\n                        <mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color"\n                            aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="folder_open"\n                            fonticon="folder_open"></mat-icon>\n                    </div>\n                    <p class="empty-state-text">No tienes carpetas a煤n.</p>\n                    <p class="empty-state-subtext">隆Crea una para empezar a organizar!</p>\n                </div>');const o=Object.keys(e).sort();for(const r of o){const o=e[r],s=await this.createFolderElement(r,o,t,n,a);i.appendChild(s)}}async createFolderElement(e,t,n,a,o){const r=document.createElement("li");r.classList.add("gemini-folder-item");const s=this.createFolderHeader(e,o),d=new i({folderName:e,conversations:t,eventHandler:a,dragAndDropHandler:o}).create();r.appendChild(s),r.appendChild(d);const[l,c,m,u]=s.children;return a.addFolderInteractionListeners(s,d,u,c,m,e,l),n[e]?(d.classList.remove("hidden"),u.setAttribute("fonticon","expand_less"),u.setAttribute("data-mat-icon-name","expand_less")):(d.classList.add("hidden"),u.setAttribute("fonticon","expand_more"),u.setAttribute("data-mat-icon-name","expand_more")),r}createFolderHeader(e,t){const n=document.createElement("div");return n.classList.add("title-container"),n.setAttribute("role","button"),n.setAttribute("tabindex","0"),n.dataset.folderName=e,n.addEventListener("dragover",t.handleDragOver.bind(t)),n.addEventListener("dragleave",t.handleDragLeave.bind(t)),n.addEventListener("drop",t.handleDrop.bind(t)),n.innerHTML=`\n            <span class="title gds-label-l gemini-folder-title" data-folder-name="${e}">${e}</span>\n            <button class="edit-folder-btn" title="Renombrar carpeta: &quot;${e}&quot;" data-folder-name="${e}"><mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="edit" fonticon="edit"></mat-icon></button>\n            <button class="delete-folder-btn" title="Eliminar carpeta: &quot;${e}&quot;" data-folder-name="${e}"><mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="delete" fonticon="delete"></mat-icon></button>\n            <mat-icon role="img" class="mat-icon notranslate gds-icon-l google-symbols mat-ligature-font mat-icon-no-color gemini-expand-icon" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="expand_more" fonticon="expand_more"></mat-icon>\n        `,n}enableEditMode(e,t,n,a,i,o){const r=e;t.style.display="none",n.style.display="none",a.style.display="none",i.style.display="none";const s=document.createElement("input");s.type="text",s.value=r,s.classList.add("folder-rename-input"),s.dataset.originalFolderName=r,t.parentNode.insertBefore(s,t),s.focus(),s.select(),o.addFolderRenameListeners(s,r,t,n,a,i)}filter(e){const t=document.getElementById("folders-list-ul");t&&t.querySelectorAll(".gemini-folder-item").forEach(t=>{const n=t.querySelector(".gemini-folder-title").textContent.toLowerCase(),a=t.querySelector(".conversations-list-wrapper"),i=a.querySelectorAll(".conversation-item-wrapper"),o=t.querySelector(".gemini-expand-icon");let r=n.includes(e),s=!1;if(i.forEach(t=>{t.dataset.convTitle.toLowerCase().includes(e)?(t.style.display="",s=!0):t.style.display="none"}),""===e)return t.style.display="",a.classList.add("hidden"),o.setAttribute("fonticon","expand_more"),o.setAttribute("data-mat-icon-name","expand_more"),void i.forEach(e=>e.style.display="");r||s?(t.style.display="",a.classList.remove("hidden"),o.setAttribute("fonticon","expand_less"),o.setAttribute("data-mat-icon-name","expand_less")):t.style.display="none"})}}class r{async display(e){const t=document.getElementById("gemini-organizer-folder-indicator");if(t&&t.remove(),!e)return;const n=await function(e,t=3e3){return new Promise(n=>{const a=Date.now();!function i(){const o=document.querySelector(e);o?n(o):Date.now()-a>t?n(null):requestAnimationFrame(i)}()})}('div[data-test-id="pillbox"]'),a=n?n.closest(".buttons-container"):null;if(!a)return void console.error("No se pudo encontrar el contenedor de botones (`.buttons-container`) para el indicador.");const i=document.createElement("div");i.id="gemini-organizer-folder-indicator",i.title=`Guardado en la carpeta: ${e}`,i.innerHTML=`\n            <mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="folder" fonticon="folder"></mat-icon>\n            <span>${e}</span>\n        `,a.prepend(i)}}class s{constructor(){this.selectors={myStuffButton:'side-nav-entry-button[data-test-id="my-stuff-side-nav-entry-button"]',newChatButton:'side-nav-action-button[data-test-id="new-chat-button"]',chatHistoryList:".chat-history-list",sidebarContainer:"mat-sidenav-container",mainContent:"main"}}getSidebarInsertionPoint(){const e=document.querySelector(this.selectors.myStuffButton);if(e)return{element:e,position:"before"};const t=document.querySelector(this.selectors.newChatButton);if(t)return{element:t,position:"after"};const n=document.querySelector(this.selectors.chatHistoryList);return n?{element:n.parentNode,position:"before"}:null}isReady(){return!!(document.querySelector(this.selectors.myStuffButton)||document.querySelector(this.selectors.newChatButton)||document.querySelector(this.selectors.chatHistoryList))}}class d{constructor(){this.sidebarComponent=new a,this.folderListComponent=new o,this.folderIndicatorComponent=new r,this.conversationListComponent=this.folderListComponent.conversationList,this.geminiAdapter=new s,this.toggleButton=null}get sidebar(){return this.sidebarComponent.element}get activeSection(){return this.sidebarComponent.activeSection}async initializeSidebar(){return this.sidebarComponent.initialize()}updateSyncStatusIcon(e){this.sidebarComponent.updateSyncStatusIcon(e)}toggleSidebarVisibility(){this.sidebarComponent.toggleVisibility()}toggleSectionVisibility(e){this.sidebarComponent.toggleSectionVisibility(e)}async renderFolders(e,t,n,a){return this.folderListComponent.renderFolders(e,t,n,a)}enableFolderEditMode(e,t,n,a,i,o){this.folderListComponent.enableEditMode(e,t,n,a,i,o)}filterConversationsAndFolders(){const e=document.getElementById("search-conversations-input"),t=e?e.value.toLowerCase().trim():"";this.folderListComponent.filter(t)}async displayFolderIndicator(e){return this.folderIndicatorComponent.display(e)}openGeminiChat(e){const t=e.target.dataset.convId;this.conversationListComponent.openChat(t,this.sidebarComponent)}async addToggleButton(e,t){const n=this.geminiAdapter.getSidebarInsertionPoint();if(n){const{element:t,position:a}=n;let i=document.getElementById("gemini-organizer-wrapper");if(!i){i=document.createElement("side-nav-action-button"),i.id="gemini-organizer-wrapper",i.setAttribute("icon","folder_open"),i.setAttribute("arialabel","Organizador de Conversaciones"),i.setAttribute("data-test-id","gemini-organizer-button"),i.classList.add("mat-mdc-tooltip-trigger","ia-redesign","ng-star-inserted");const e=document.createElement("button");e.id="gemini-organizer-toggle-btn",e.classList.add("mat-mdc-list-item","mdc-list-item","side-nav-action-button","explicit-gmat-override","mat-mdc-list-item-interactive","mdc-list-item--with-leading-icon","mat-mdc-list-item-single-line","mdc-list-item--with-one-line","ng-star-inserted"),e.type="button",e.setAttribute("aria-label","Organizador de Conversaciones"),e.setAttribute("aria-disabled","false"),e.innerHTML='\n                    <div matlistitemicon="" class="mat-mdc-list-item-icon icon-container mdc-list-item__start" style="margin-left: 0px;margin-right: 0px;">\n                        <mat-icon role="img" class="mat-icon notranslate gds-icon-l google-symbols mat-ligature-font mat-icon-no-color ng-star-inserted" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="folder_open" fonticon="folder_open"></mat-icon>\n                    </div>\n                    <span class="mdc-list-item__content">\n                        <span class="mat-mdc-list-item-unscoped-content mdc-list-item__primary-text">\n                            <span data-test-id="side-nav-action-button-content" class="gds-body-m">Mis conversaciones</span>\n                        </span>\n                    </span>\n                    <div class="mat-focus-indicator"></div>\n                ',i.appendChild(e),"before"===a?t.parentNode.insertBefore(i,t):t.after(i),this.toggleButton=e}this.sidebarComponent.element||await this.initializeSidebar(),this.sidebarComponent.element&&!i.contains(this.sidebarComponent.element)&&i.appendChild(this.sidebarComponent.element),e.addEventListeners()}}}class l{constructor(e){this.key=e,this.storageArea=null}async setStorageArea(e){return this.storageArea="sync"===e?chrome.storage.sync:chrome.storage.local,console.log("rea de almacenamiento establecida en: "+(this.storageArea===chrome.storage.sync?"sync":"local")),this}async getFolders(){return(await this.storageArea.get(this.key))[this.key]||{}}async saveFolders(e){return this.storageArea.set({[this.key]:e})}async getSyncEnabled(){return(await chrome.storage.sync.get("syncEnabled")).syncEnabled||!1}async setSyncEnabled(e){return chrome.storage.sync.set({syncEnabled:e})}}class c{constructor(e,t){this.storage=e,this.ui=t}async loadAndDisplayFolders(){const e=this.getOpenFolderStates(),t=await this.storage.getFolders();this.ui.renderFolders(t,e,this.eventHandler,this.dragAndDropHandler)}async createFolder(){const t=document.getElementById("new-folder-name"),n=t.value.trim();if(n){const a=await this.storage.getFolders();a[n]?e(`La carpeta "${n}" ya existe.`,"warning"):(a[n]=[],await this.storage.saveFolders(a),t.value="",e(`Carpeta "${n}" creada exitosamente.`,"success"))}else e("Por favor, ingresa un nombre para la carpeta.","warning")}async saveFolderRename(t,n,a,i,o,r){const s=t.value.trim();if(!t.parentNode)return;if(s===n)return t.remove(),a.style.display="block",i.style.display="block",o.style.display="block",void(r.style.display="block");if(!s)return e("El nombre de la carpeta no puede estar vac铆o. Se restaurar谩 el nombre original.","warning"),t.remove(),a.style.display="block",i.style.display="block",o.style.display="block",void(r.style.display="block");const d=await this.storage.getFolders();if(d[s]&&s!==n)return e(`Ya existe una carpeta con el nombre "${s}". Por favor, elige un nombre diferente.`,"warning"),t.remove(),a.style.display="block",i.style.display="block",o.style.display="block",void(r.style.display="block");const l=d[n];delete d[n],d[s]=l,await this.storage.saveFolders(d),e(`Carpeta "${n}" renombrada a "${s}" exitosamente.`,"success"),t.remove()}async deleteFolder(t){t.stopPropagation();const n=t.currentTarget.dataset.folderName;if(!n)return void e("Hubo un error al intentar eliminar la carpeta.","error");if(!confirm(`驴Est谩s seguro de que quieres eliminar la carpeta "${n}"?`))return;const a=await this.storage.getFolders();a[n]?(delete a[n],await this.storage.saveFolders(a),e(`Carpeta "${n}" eliminada.`,"success")):e("La carpeta especificada no existe.","error")}async deleteConversation(t){if(!confirm("驴Est谩s seguro de que quieres eliminar esta conversaci贸n?"))return;const n=t.currentTarget.dataset.folderName,a=t.currentTarget.dataset.convId;if(!n||!a)return void e("Hubo un error al intentar eliminar la conversaci贸n.","error");const i=await this.storage.getFolders();i[n]?(i[n]=i[n].filter(e=>e.id!==a),await this.storage.saveFolders(i),e("Conversaci贸n eliminada.","success")):e("La carpeta especificada no existe.","error")}getOpenFolderStates(){const e={},t=document.getElementById("folders-list-ul");return t&&t.querySelectorAll(".gemini-folder-item").forEach(t=>{const n=t.querySelector(".gemini-folder-title").dataset.folderName,a=t.querySelector(".conversations-list-wrapper");a&&!a.classList.contains("hidden")&&(e[n]=!0)}),e}async saveCurrentConversation(n){const a=window.location.href,i=t(),o=function(){const e=document.querySelector(".conversation.selected .conversation-title");if(e)return e.textContent.trim();const t=document.querySelector(".bot-item.selected .bot-name");if(t)return t.textContent.trim();const n=document.title;if(n&&n.includes("Gemini")){const e=n.replace(/^(.*?) - Gemini.*$/,"$1").trim();if(e&&"Gemini"!==e)return e}return"Conversaci贸n sin t铆tulo"}();if(!i||!o)return void e("No se pudo obtener la informaci贸n de la conversaci贸n actual.","error");const r=await this.storage.getFolders();r[n]?r[n].find(e=>e.id===i)?e("Esta conversaci贸n ya est谩 guardada en esta carpeta.","info"):(r[n].push({id:i,title:o,url:a,timestamp:(new Date).toLocaleString()}),await this.storage.saveFolders(r),e(`Conversaci贸n guardada en la carpeta "${n}".`,"success")):e(`La carpeta "${n}" no existe.`,"error")}async findFolderForConversation(e){if(!e)return null;try{if(!chrome.runtime?.id)return console.warn("Gemini Organizer: Context invalidated, skipping folder check."),null;const t=await this.storage.getFolders();if(chrome.runtime.lastError)return console.warn("Gemini Organizer: Context invalidated during storage access.",chrome.runtime.lastError.message),null;for(const n in t)if(t[n].some(t=>t.id===e))return n;return null}catch(e){return console.warn("Gemini Organizer: Could not check for folder (context likely invalidated).",e.message),null}}setEventHandler(e){this.eventHandler=e}setDragAndDropHandler(e){this.dragAndDropHandler=e}}class m{constructor(e,t){this.storage=e,this.folderManager=t}handleDragStart(e){const n=e.target.closest('.chat-history-list .conversation[data-test-id="conversation"]'),a=e.target.closest('.conversation-item-wrapper[draggable="true"]');let i;if(n){const e=n.querySelector(".conversation-title"),a=e?e.textContent.trim():"Conversaci贸n sin t铆tulo";let o=null,r="";const s=n.getAttribute("jslog");if(s){const e=s.match(/["']c_([^"']+)["']/);e&&e[1]&&(o=e[1],r=`https://gemini.google.com/app/${o}`)}!o&&n.classList.contains("selected")&&(o=t(),o&&(r=`https://gemini.google.com/app/${o}`)),o||(o="fallback_"+Date.now().toString()),i={id:o,title:a,url:r||window.location.href,folder_from:null,original_index:-1},n.classList.add("is-dragging")}else{if(!a)return void e.preventDefault();i={id:a.dataset.convId,title:a.dataset.convTitle,url:a.dataset.convUrl,folder_from:a.dataset.folderName,original_index:parseInt(a.dataset.originalIndex)},a.classList.add("is-dragging")}e.dataTransfer.setData("application/json",JSON.stringify(i)),e.dataTransfer.effectAllowed="move"}handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move",e.currentTarget&&e.currentTarget.classList.contains("title-container")&&e.currentTarget.classList.add("drag-over")}handleDragLeave(e){e.currentTarget&&e.currentTarget.classList.contains("title-container")&&e.currentTarget.classList.remove("drag-over"),e.currentTarget.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(e=>{e.classList.remove("drag-over-top","drag-over-bottom")})}async handleDrop(t){t.preventDefault(),t.currentTarget&&t.currentTarget.classList.contains("title-container")&&t.currentTarget.classList.remove("drag-over");const n=t.dataTransfer.getData("application/json");if(!n)return;const a=JSON.parse(n),i=t.currentTarget.dataset.folderName,o=a.folder_from;if(!i)return;const r=await this.storage.getFolders();o&&o!==i&&(r[o]=r[o].filter(e=>e.id!==a.id)),r[i].some(e=>e.id===a.id)||r[i].push({id:a.id,title:a.title,url:a.url,timestamp:(new Date).toLocaleString()}),await this.storage.saveFolders(r),e(`Conversaci贸n movida a "${i}"`,"success")}handleConversationListDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest(".conversation-item-wrapper"),n=e.currentTarget;if(n.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(e=>e.classList.remove("drag-over-top","drag-over-bottom")),t){const n=t.getBoundingClientRect();e.clientY-n.top<n.height/2?t.classList.add("drag-over-top"):t.classList.add("drag-over-bottom")}else n.classList.add("drag-over-bottom")}async handleConversationListDrop(t){t.preventDefault(),t.currentTarget.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(e=>e.classList.remove("drag-over-top","drag-over-bottom"));const n=t.dataTransfer.getData("application/json");if(!n)return;const a=JSON.parse(n),i=t.currentTarget.dataset.folderName,o=a.folder_from,r=a.original_index;if(!i)return;const s=await this.storage.getFolders(),d=t.target.closest(".conversation-item-wrapper");let l;if(d){const e=d.getBoundingClientRect(),n=t.clientY-e.top,a=Array.from(d.parentNode.children).indexOf(d);l=n<e.height/2?a:a+1}else l=s[i].length;if(o===i){const[e]=s[i].splice(r,1);s[i].splice(l>r?l-1:l,0,e)}else o&&(s[o]=s[o].filter(e=>e.id!==a.id)),s[i].some(e=>e.id===a.id)||s[i].splice(l,0,{id:a.id,title:a.title,url:a.url,timestamp:(new Date).toLocaleString()});await this.storage.saveFolders(s),e("Conversaci贸n reordenada","success")}async setupDraggableConversations(){const e=document.querySelectorAll('.chat-history-list .conversation[data-test-id="conversation"]'),t=await this.storage.getFolders(),n=new Set;for(const e in t)t[e].forEach(e=>n.add(e.id));e.forEach(e=>{e.hasAttribute("data-draggable-setup")||(e.setAttribute("draggable","true"),e.addEventListener("dragstart",this.handleDragStart.bind(this)),e.addEventListener("dragend",e=>e.target.classList.remove("is-dragging")),e.setAttribute("data-draggable-setup","true"));const t=e.getAttribute("jslog");let a=null;if(t){const e=t.match(/["']c_([^"']+)["']/);e&&e[1]&&(a=e[1])}const i=e.querySelector(".conversation-title");if(a&&n.has(a)){e.classList.add("is-saved");let t=i.querySelector(".gemini-organizer-saved-icon");t||(t=document.createElement("span"),t.classList.add("gemini-organizer-saved-icon"),t.textContent="",i.insertBefore(t,i.firstChild))}else{e.classList.remove("is-saved");const t=i.querySelector(".gemini-organizer-saved-icon");t&&t.remove()}})}}class u{constructor(e,t,n){this.ui=e,this.folderManager=t,this.dragAndDropHandler=n}addEventListeners(){const e=document.getElementById("create-folder-section-btn");e&&e.addEventListener("click",()=>this.ui.toggleSectionVisibility("create-folder-container"));const t=document.getElementById("search-section-btn");t&&t.addEventListener("click",()=>this.ui.toggleSectionVisibility("search-conversations-container"));const n=document.getElementById("create-folder-btn");n&&n.addEventListener("click",this.folderManager.createFolder.bind(this.folderManager));const a=document.getElementById("search-conversations-input");a&&a.addEventListener("input",this.ui.filterConversationsAndFolders.bind(this.ui)),this.ui.toggleButton&&this.ui.toggleButton.addEventListener("click",this.ui.toggleSidebarVisibility.bind(this.ui))}addFolderInteractionListeners(e,t,n,a,i,o,r){e.addEventListener("click",()=>{t.classList.toggle("hidden");const e=t.classList.contains("hidden");n.setAttribute("fonticon",e?"expand_more":"expand_less"),n.setAttribute("data-mat-icon-name",e?"expand_more":"expand_less")}),a.addEventListener("click",e=>{e.stopPropagation(),this.ui.enableFolderEditMode(o,r,i,a,n,this)}),i.addEventListener("click",this.folderManager.deleteFolder.bind(this.folderManager))}addFolderRenameListeners(e,t,n,a,i,o){e.addEventListener("keypress",r=>{"Enter"===r.key&&this.folderManager.saveFolderRename(e,t,n,a,i,o)}),e.addEventListener("blur",()=>{this.folderManager.saveFolderRename(e,t,n,a,i,o)})}addConversationListeners(e){const t=e.querySelector(".conversation-title");t&&t.addEventListener("click",this.ui.openGeminiChat.bind(this.ui));const n=e.querySelector(".delete-conversation-btn");n&&n.addEventListener("click",this.folderManager.deleteConversation.bind(this.folderManager))}}if(window.geminiOrganizerAppInstance)console.warn("Gemini Organizer: Intento de re-inicializaci贸n bloqueado. La instancia ya existe.");else{class e{constructor(){this.ui=new d,this.storage=new l("geminiConversations"),this.folderManager=new c(this.storage,this.ui),this.dragAndDropHandler=new m(this.storage,this.folderManager),this.eventHandler=new u(this.ui,this.folderManager,this.dragAndDropHandler),this.folderManager.setEventHandler(this.eventHandler),this.folderManager.setDragAndDropHandler(this.dragAndDropHandler),this.observer=new MutationObserver(this.handleMutations.bind(this)),chrome.storage.onChanged.addListener(this.handleStorageChange.bind(this)),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),this.lastUrl=window.location.href,this.isHandlingMutations=!1}async init(){if(!document.getElementById("gemini-organizer-toast-container")){const e=document.createElement("div");e.id="gemini-organizer-toast-container",document.body.appendChild(e)}await this.setupStorage(),window.requestIdleCallback(async()=>{await this.ui.addToggleButton(this.eventHandler,this.folderManager),await this.folderManager.loadAndDisplayFolders(),this.dragAndDropHandler.setupDraggableConversations(),await this.updateFolderIndicator(),this.updateSidebarSyncStatus(),this.observer.observe(document.body,{childList:!0,subtree:!0})})}async setupStorage(){const e=await this.storage.getSyncEnabled();return await this.storage.setStorageArea(e?"sync":"local"),e}async updateSidebarSyncStatus(){const e=await this.storage.getSyncEnabled();this.ui.sidebar||await this.ui.initializeSidebar(),this.ui.updateSyncStatusIcon(e);const t=document.getElementById("open-options-btn");if(t){const e=t.cloneNode(!0);t.parentNode.replaceChild(e,t),e.addEventListener("click",()=>{chrome.runtime.sendMessage({action:"openOptionsPage"})})}}async handleMutations(){if(!this.isHandlingMutations){this.isHandlingMutations=!0,this.observer.disconnect();try{const e=document.getElementById("gemini-organizer-wrapper");e&&document.body.contains(e)||(await this.ui.addToggleButton(this.eventHandler,this.folderManager),await this.folderManager.loadAndDisplayFolders(),this.updateSidebarSyncStatus()),this.dragAndDropHandler.setupDraggableConversations(),window.location.href!==this.lastUrl&&(this.lastUrl=window.location.href,await this.updateFolderIndicator())}catch(e){console.error("Error en handleMutations:",e)}finally{this.observer.observe(document.body,{childList:!0,subtree:!0}),this.isHandlingMutations=!1}}}async updateFolderIndicator(){try{const e=function(){const e=document.querySelector(".conversation.selected");if(e){const t=e.getAttribute("jslog");if(t){const e=t.match(/BardVeMetadataKey:\[[^\]]*\\x22c_([^\x22]+)\\x22/);if(e&&e[1])return e[1]}}return t()}(),n=await this.folderManager.findFolderForConversation(e);await this.ui.displayFolderIndicator(n)}catch(e){console.error("Error al actualizar el indicador de carpeta:",e),this.ui.displayFolderIndicator(null)}}async handleStorageChange(e,t){"sync"===t&&(e.syncEnabled||e[this.storage.key])?(console.log("La configuraci贸n de Sync ha cambiado. Recargando..."),await this.setupStorage(),await this.folderManager.loadAndDisplayFolders(),this.updateSidebarSyncStatus()):"local"===t&&e[this.storage.key]&&(console.log("El almacenamiento local ha cambiado. Recargando las carpetas."),this.folderManager.loadAndDisplayFolders())}handleMessage(e,t,n){return"save_current_conversation_to_folder"===e.action&&this.folderManager.saveCurrentConversation(e.folderName),!0}}window.geminiOrganizerAppInstance=new e,window.geminiOrganizerAppInstance.init()}})();