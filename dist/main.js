(()=>{"use strict";async function e(e){const t=chrome.runtime.getURL(e);try{const e=await fetch(t);if(!e.ok)throw new Error(`Error al cargar el template: ${e.statusText}`);return await e.text()}catch(t){return console.error(`No se pudo obtener el template: ${e}`,t),""}}class t{constructor(){this.sidebar=null,this.toggleButton=null,this.activeSection=null}async initializeSidebar(){let t=document.getElementById("gemini-organizer-sidebar");return t||(t=document.createElement("div"),t.id="gemini-organizer-sidebar",t.classList.add("hidden"),t.innerHTML=await e("src/templates/sidebar.html")),this.sidebar=t,t}updateSyncStatusIcon(e){const t=document.getElementById("sync-status-icon");t&&(e?(t.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="cloud" fonticon="cloud"></mat-icon>',t.title="Carpetas sincronizadas con tu cuenta de Google."):(t.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="cloud_off" fonticon="cloud_off"></mat-icon>',t.title="Carpetas guardadas localmente en este dispositivo."))}async addToggleButton(e,t){const a=document.querySelector('side-nav-action-button[data-test-id="manage-instructions-control"]');if(a){let t=document.getElementById("gemini-organizer-wrapper");if(!t){t=document.createElement("side-nav-action-button"),t.id="gemini-organizer-wrapper",t.setAttribute("icon","folder_open"),t.setAttribute("arialabel","Organizador de Conversaciones"),t.setAttribute("data-test-id","gemini-organizer-button"),t.classList.add("mat-mdc-tooltip-trigger","ia-redesign","ng-star-inserted");const e=document.createElement("button");e.id="gemini-organizer-toggle-btn",e.classList.add("mat-mdc-list-item","mdc-list-item","side-nav-action-button","explicit-gmat-override","mat-mdc-list-item-interactive","mdc-list-item--with-leading-icon","mat-mdc-list-item-single-line","mdc-list-item--with-one-line","ng-star-inserted"),e.type="button",e.setAttribute("aria-label","Organizador de Conversaciones"),e.setAttribute("aria-disabled","false"),e.innerHTML='\n                    <div matlistitemicon="" class="mat-mdc-list-item-icon icon-container mdc-list-item__start" style="margin-left: 0px;margin-right: 0px;">\n                        <mat-icon role="img" class="mat-icon notranslate gds-icon-l google-symbols mat-ligature-font mat-icon-no-color ng-star-inserted" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="folder_open" fonticon="folder_open"></mat-icon>\n                    </div>\n                    <span class="mdc-list-item__content">\n                        <span class="mat-mdc-list-item-unscoped-content mdc-list-item__primary-text">\n                            <span data-test-id="side-nav-action-button-content" class="gds-body-m">Mis conversaciones</span>\n                        </span>\n                    </span>\n                    <div class="mat-focus-indicator"></div>\n                ',t.appendChild(e),a.after(t),this.toggleButton=e}this.sidebar||await this.initializeSidebar(),this.sidebar&&!t.contains(this.sidebar)&&t.appendChild(this.sidebar),e.addEventListeners()}}toggleSidebarVisibility(){this.sidebar&&(this.sidebar.classList.toggle("hidden"),this.sidebar.classList.contains("hidden")&&this.toggleSectionVisibility(null))}toggleSectionVisibility(e){const t=document.getElementById("create-folder-container"),a=document.getElementById("search-conversations-container"),n=document.getElementById("create-folder-section-btn"),s=document.getElementById("search-section-btn");this.activeSection===e&&(e=null),this.activeSection=e,t&&a&&(t.classList.toggle("hidden","create-folder-container"!==e),a.classList.toggle("hidden","search-conversations-container"!==e)),n&&s&&(n.classList.toggle("active","create-folder-container"===e),s.classList.toggle("active","search-conversations-container"===e))}async renderFolders(e,t,a,n){const s=document.getElementById("folders-list-ul");if(!s)return;s.innerHTML="";const r=Object.keys(e).sort();(await Promise.all(r.map(s=>{const r=e[s];return this.createFolderElement(s,r,t,a,n)}))).forEach(e=>s.appendChild(e))}async createFolderElement(e,t,a,n,s){const r=document.createElement("li");r.classList.add("gemini-folder-item");const i=await this.createFolderHeader(e,s),o=await this.createConversationsWrapper(e,t,n,s);r.appendChild(i),r.appendChild(o);const[d,l,c,g]=i.children;return n.addFolderInteractionListeners(i,o,g,l,c,e,d),a[e]?(o.classList.remove("hidden"),g.setAttribute("fonticon","expand_less"),g.setAttribute("data-mat-icon-name","expand_less")):(o.classList.add("hidden"),g.setAttribute("fonticon","expand_more"),g.setAttribute("data-mat-icon-name","expand_more")),r}async createFolderHeader(t,a){const n=document.createElement("div");n.classList.add("title-container"),n.setAttribute("role","button"),n.setAttribute("tabindex","0"),n.dataset.folderName=t,n.addEventListener("dragover",a.handleDragOver.bind(a)),n.addEventListener("dragleave",a.handleDragLeave.bind(a)),n.addEventListener("drop",a.handleDrop.bind(a));const s=await e("src/templates/folderHeader.html");return n.innerHTML=s.replace(/{{folderName}}/g,t),n}async createConversationsWrapper(e,t,a,n){const s=document.createElement("div");s.classList.add("conversations-list-wrapper");const r=document.createElement("ul");return r.classList.add("conversation-items-container","side-nav-opened"),r.dataset.folderName=e,r.addEventListener("dragover",n.handleConversationListDragOver.bind(n)),r.addEventListener("drop",n.handleConversationListDrop.bind(n)),(await Promise.all(t.map((t,s)=>this.createConversationElement(t,e,s,a,n)))).forEach(e=>r.appendChild(e)),s.appendChild(r),s}async createConversationElement(t,a,n,s,r){const i=document.createElement("li");i.classList.add("conversation-item-wrapper"),i.setAttribute("draggable","true"),i.dataset.folderName=a,i.dataset.convId=t.id,i.dataset.convTitle=t.title,i.dataset.convUrl=t.url,i.dataset.originalIndex=n,i.addEventListener("dragstart",r.handleDragStart.bind(r)),i.addEventListener("dragend",e=>e.target.classList.remove("is-dragging"));const o=await e("src/templates/conversationItem.html");return i.innerHTML=o.replace(/{{folderName}}/g,a).replace(/{{convId}}/g,t.id).replace(/{{convTitle}}/g,t.title),s.addConversationListeners(i),i}enableFolderEditMode(e,t,a,n,s,r){const i=e;t.style.display="none",a.style.display="none",n.style.display="none",s.style.display="none";const o=document.createElement("input");o.type="text",o.value=i,o.classList.add("folder-rename-input"),o.dataset.originalFolderName=i,t.parentNode.insertBefore(o,t),o.focus(),o.select(),r.addFolderRenameListeners(o,i,t,a,n,s)}openGeminiChat(e){const t=e.target.dataset.convId;if(t){const e='.chat-history-list .conversation[jslog*="\\"c_'+t+'\\""]',a=document.querySelector(e);if(a){const e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0,buttons:1}),t=new MouseEvent("mousedown",{view:window,bubbles:!0,cancelable:!0,buttons:1}),n=new MouseEvent("mouseup",{view:window,bubbles:!0,cancelable:!0});a.dispatchEvent(t),a.dispatchEvent(n),a.dispatchEvent(e),setTimeout(()=>{this.sidebar.classList.add("hidden")},100)}else showToast("No se pudo cargar la conversación rápidamente. Recargando página...","info"),window.location.href=`https://gemini.google.com/app/${t}`,this.sidebar.classList.add("hidden")}else showToast("No se pudo encontrar el ID de esta conversación.","error")}filterConversationsAndFolders(){const e=document.getElementById("search-conversations-input").value.toLowerCase().trim();document.getElementById("folders-list-ul").querySelectorAll(".gemini-folder-item").forEach(t=>{const a=t.querySelector(".gemini-folder-title").textContent.toLowerCase(),n=t.querySelector(".conversations-list-wrapper"),s=n.querySelectorAll(".conversation-item-wrapper"),r=t.querySelector(".gemini-expand-icon");let i=a.includes(e),o=!1;if(s.forEach(t=>{t.querySelector(".conversation-title").textContent.toLowerCase().includes(e)?(t.style.display="",o=!0):t.style.display="none"}),""===e)return t.style.display="",n.classList.add("hidden"),r.setAttribute("fonticon","expand_more"),r.setAttribute("data-mat-icon-name","expand_more"),void s.forEach(e=>e.style.display="");i||o?(t.style.display="",n.classList.remove("hidden"),r.setAttribute("fonticon","expand_less"),r.setAttribute("data-mat-icon-name","expand_less")):t.style.display="none"})}}class a{constructor(e){this.key=e,this.storageArea=null}async setStorageArea(e){return this.storageArea="sync"===e?chrome.storage.sync:chrome.storage.local,console.log("Área de almacenamiento establecida en: "+(this.storageArea===chrome.storage.sync?"sync":"local")),this}async getFolders(){return(await this.storageArea.get(this.key))[this.key]||{}}async saveFolders(e){return this.storageArea.set({[this.key]:e})}async getSyncEnabled(){return(await chrome.storage.sync.get("syncEnabled")).syncEnabled||!1}async setSyncEnabled(e){return chrome.storage.sync.set({syncEnabled:e})}}class n{constructor(e,t){this.storage=e,this.ui=t}async loadAndDisplayFolders(){const e=this.getOpenFolderStates(),t=await this.storage.getFolders();this.ui.renderFolders(t,e,this.eventHandler,this.dragAndDropHandler)}async createFolder(){const e=document.getElementById("new-folder-name"),t=e.value.trim();if(t){const a=await this.storage.getFolders();a[t]?showToast(`La carpeta "${t}" ya existe.`,"warning"):(a[t]=[],await this.storage.saveFolders(a),e.value="",showToast(`Carpeta "${t}" creada exitosamente.`,"success"))}else showToast("Por favor, ingresa un nombre para la carpeta.","warning")}async saveFolderRename(e,t,a,n,s,r){const i=e.value.trim();if(!e.parentNode)return;if(i===t)return e.remove(),a.style.display="block",n.style.display="block",s.style.display="block",void(r.style.display="block");if(!i)return showToast("El nombre de la carpeta no puede estar vacío. Se restaurará el nombre original.","warning"),e.remove(),a.style.display="block",n.style.display="block",s.style.display="block",void(r.style.display="block");const o=await this.storage.getFolders();if(o[i]&&i!==t)return showToast(`Ya existe una carpeta con el nombre "${i}". Por favor, elige un nombre diferente.`,"warning"),e.remove(),a.style.display="block",n.style.display="block",s.style.display="block",void(r.style.display="block");const d=o[t];delete o[t],o[i]=d,await this.storage.saveFolders(o),showToast(`Carpeta "${t}" renombrada a "${i}" exitosamente.`,"success"),e.remove()}async deleteFolder(e){e.stopPropagation();const t=e.currentTarget.dataset.folderName;if(!t)return void showToast("Hubo un error al intentar eliminar la carpeta.","error");if(!confirm(`¿Estás seguro de que quieres eliminar la carpeta "${t}"?`))return;const a=await this.storage.getFolders();a[t]?(delete a[t],await this.storage.saveFolders(a),showToast(`Carpeta "${t}" eliminada.`,"success")):showToast("La carpeta especificada no existe.","error")}async deleteConversation(e){if(!confirm("¿Estás seguro de que quieres eliminar esta conversación?"))return;const t=e.currentTarget.dataset.folderName,a=e.currentTarget.dataset.convId;if(!t||!a)return void showToast("Hubo un error al intentar eliminar la conversación.","error");const n=await this.storage.getFolders();n[t]?(n[t]=n[t].filter(e=>e.id!==a),await this.storage.saveFolders(n),showToast("Conversación eliminada.","success")):showToast("La carpeta especificada no existe.","error")}getOpenFolderStates(){const e={},t=document.getElementById("folders-list-ul");return t&&t.querySelectorAll(".gemini-folder-item").forEach(t=>{const a=t.querySelector(".gemini-folder-title").dataset.folderName,n=t.querySelector(".conversations-list-wrapper");n&&!n.classList.contains("hidden")&&(e[a]=!0)}),e}async saveCurrentConversation(e){const t=window.location.href,a=extractRealConversationIdFromCurrentUrl(),n=extractConversationTitle();if(!a||!n)return void showToast("No se pudo obtener la información de la conversación actual.","error");const s=await this.storage.getFolders();s[e]?s[e].find(e=>e.id===a)?showToast("Esta conversación ya está guardada en esta carpeta.","info"):(s[e].push({id:a,title:n,url:t,timestamp:(new Date).toLocaleString()}),await this.storage.saveFolders(s),showToast(`Conversación guardada en la carpeta "${e}".`,"success")):showToast(`La carpeta "${e}" no existe.`,"error")}setEventHandler(e){this.eventHandler=e}setDragAndDropHandler(e){this.dragAndDropHandler=e}}class s{constructor(e,t){this.storage=e,this.folderManager=t}handleDragStart(e){const t=e.target.closest('.chat-history-list .conversation[data-test-id="conversation"]'),a=e.target.closest('.conversation-item-wrapper[draggable="true"]');let n;if(t){const e=t.querySelector(".conversation-title"),a=e?e.textContent.trim():"Conversación sin título";let s=null,r="";const i=t.getAttribute("jslog");if(i){const e=i.match(/BardVeMetadataKey:\[[^\]]*\x22c_([^\x22]+)\x22/);e&&e[1]&&(s=e[1],r=`https://gemini.google.com/app/${s}`)}!s&&t.classList.contains("selected")&&(s=extractRealConversationIdFromCurrentUrl(),s&&(r=`https://gemini.google.com/app/${s}`)),s||(s="fallback_"+Date.now().toString()),n={id:s,title:a,url:r||window.location.href,folder_from:null,original_index:-1},t.classList.add("is-dragging")}else{if(!a)return void e.preventDefault();n={id:a.dataset.convId,title:a.dataset.convTitle,url:a.dataset.convUrl,folder_from:a.dataset.folderName,original_index:parseInt(a.dataset.originalIndex)},a.classList.add("is-dragging")}e.dataTransfer.setData("application/json",JSON.stringify(n)),e.dataTransfer.effectAllowed="move"}handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move",e.currentTarget&&e.currentTarget.classList.contains("title-container")&&e.currentTarget.classList.add("drag-over")}handleDragLeave(e){e.currentTarget&&e.currentTarget.classList.contains("title-container")&&e.currentTarget.classList.remove("drag-over"),e.currentTarget.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(e=>{e.classList.remove("drag-over-top","drag-over-bottom")})}async handleDrop(e){e.preventDefault(),e.currentTarget&&e.currentTarget.classList.contains("title-container")&&e.currentTarget.classList.remove("drag-over");const t=e.dataTransfer.getData("application/json");if(!t)return;const a=JSON.parse(t),n=e.currentTarget.dataset.folderName,s=a.folder_from;if(!n)return;const r=await this.storage.getFolders();s&&s!==n&&(r[s]=r[s].filter(e=>e.id!==a.id)),r[n].some(e=>e.id===a.id)||r[n].push({id:a.id,title:a.title,url:a.url,timestamp:(new Date).toLocaleString()}),await this.storage.saveFolders(r),showToast(`Conversación movida a "${n}"`,"success")}handleConversationListDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest(".conversation-item-wrapper"),a=e.currentTarget;if(a.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(e=>e.classList.remove("drag-over-top","drag-over-bottom")),t){const a=t.getBoundingClientRect();e.clientY-a.top<a.height/2?t.classList.add("drag-over-top"):t.classList.add("drag-over-bottom")}else a.classList.add("drag-over-bottom")}async handleConversationListDrop(e){e.preventDefault(),e.currentTarget.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(e=>e.classList.remove("drag-over-top","drag-over-bottom"));const t=e.dataTransfer.getData("application/json");if(!t)return;const a=JSON.parse(t),n=e.currentTarget.dataset.folderName,s=a.folder_from,r=a.original_index;if(!n)return;const i=await this.storage.getFolders(),o=e.target.closest(".conversation-item-wrapper");let d;if(o){const t=o.getBoundingClientRect(),a=e.clientY-t.top,n=Array.from(o.parentNode.children).indexOf(o);d=a<t.height/2?n:n+1}else d=i[n].length;if(s===n){const[e]=i[n].splice(r,1);i[n].splice(d>r?d-1:d,0,e)}else s&&(i[s]=i[s].filter(e=>e.id!==a.id)),i[n].some(e=>e.id===a.id)||i[n].splice(d,0,{id:a.id,title:a.title,url:a.url,timestamp:(new Date).toLocaleString()});await this.storage.saveFolders(i),showToast("Conversación reordenada","success")}async setupDraggableConversations(){const e=document.querySelectorAll('.chat-history-list .conversation[data-test-id="conversation"]'),t=await this.storage.getFolders(),a=new Set;for(const e in t)t[e].forEach(e=>a.add(e.id));e.forEach(e=>{e.hasAttribute("data-draggable-setup")||(e.setAttribute("draggable","true"),e.addEventListener("dragstart",this.handleDragStart.bind(this)),e.addEventListener("dragend",e=>e.target.classList.remove("is-dragging")),e.setAttribute("data-draggable-setup","true"));const t=e.getAttribute("jslog");let n=null;if(t){const e=t.match(/BardVeMetadataKey:\[[^\]]*\x22c_([^\x22]+)\x22/);e&&e[1]&&(n=e[1])}const s=e.querySelector(".conversation-title");if(n&&a.has(n)){e.classList.add("is-saved");let t=s.querySelector(".gemini-organizer-saved-icon");t||(t=document.createElement("span"),t.classList.add("gemini-organizer-saved-icon"),t.textContent="📁",s.insertBefore(t,s.firstChild))}else{e.classList.remove("is-saved");const t=s.querySelector(".gemini-organizer-saved-icon");t&&t.remove()}})}}class r{constructor(e,t,a){this.ui=e,this.folderManager=t,this.dragAndDropHandler=a}addEventListeners(){const e=document.getElementById("create-folder-section-btn");e&&e.addEventListener("click",()=>this.ui.toggleSectionVisibility("create-folder-container"));const t=document.getElementById("search-section-btn");t&&t.addEventListener("click",()=>this.ui.toggleSectionVisibility("search-conversations-container"));const a=document.getElementById("create-folder-btn");a&&a.addEventListener("click",this.folderManager.createFolder.bind(this.folderManager));const n=document.getElementById("search-conversations-input");n&&n.addEventListener("input",this.ui.filterConversationsAndFolders.bind(this.ui)),this.ui.toggleButton&&this.ui.toggleButton.addEventListener("click",this.ui.toggleSidebarVisibility.bind(this.ui))}addFolderInteractionListeners(e,t,a,n,s,r,i){e.addEventListener("click",()=>{t.classList.toggle("hidden");const e=t.classList.contains("hidden");a.setAttribute("fonticon",e?"expand_more":"expand_less"),a.setAttribute("data-mat-icon-name",e?"expand_more":"expand_less")}),n.addEventListener("click",e=>{e.stopPropagation(),this.ui.enableFolderEditMode(r,i,s,n,a,this)}),s.addEventListener("click",this.folderManager.deleteFolder.bind(this.folderManager))}addFolderRenameListeners(e,t,a,n,s,r){e.addEventListener("keypress",i=>{"Enter"===i.key&&this.folderManager.saveFolderRename(e,t,a,n,s,r)}),e.addEventListener("blur",()=>{this.folderManager.saveFolderRename(e,t,a,n,s,r)})}addConversationListeners(e){const t=e.querySelector(".conversation-title");t&&t.addEventListener("click",this.ui.openGeminiChat.bind(this.ui));const a=e.querySelector(".delete-conversation-btn");a&&a.addEventListener("click",this.folderManager.deleteConversation.bind(this.folderManager))}}(new class{constructor(){this.ui=new t,this.storage=new a("geminiConversations"),this.folderManager=new n(this.storage,this.ui),this.dragAndDropHandler=new s(this.storage,this.folderManager),this.eventHandler=new r(this.ui,this.folderManager,this.dragAndDropHandler),this.folderManager.setEventHandler(this.eventHandler),this.folderManager.setDragAndDropHandler(this.dragAndDropHandler),this.observer=new MutationObserver(this.handleMutations.bind(this)),chrome.storage.onChanged.addListener(this.handleStorageChange.bind(this)),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this))}async init(){if(!document.getElementById("gemini-organizer-toast-container")){const e=document.createElement("div");e.id="gemini-organizer-toast-container",document.body.appendChild(e)}await this.initializeSync(),window.requestIdleCallback(async()=>{await this.ui.addToggleButton(this.eventHandler,this.folderManager),this.dragAndDropHandler.setupDraggableConversations(),this.observer.observe(document.body,{childList:!0,subtree:!0})})}async initializeSync(){const e=await this.storage.getSyncEnabled();await this.storage.setStorageArea(e?"sync":"local"),await this.folderManager.loadAndDisplayFolders(),setTimeout(async()=>{this.ui.sidebar||await this.ui.initializeSidebar(),this.ui.updateSyncStatusIcon(e);const t=document.getElementById("open-options-btn");t&&t.addEventListener("click",()=>{chrome.runtime.sendMessage({action:"openOptionsPage"})})},500)}async handleMutations(){const e=document.getElementById("gemini-organizer-wrapper");e&&document.body.contains(e)||(await this.ui.addToggleButton(this.eventHandler,this.folderManager),await this.initializeSync()),this.dragAndDropHandler.setupDraggableConversations()}handleStorageChange(e,t){"sync"===t&&(e.syncEnabled||e[this.storage.key])?(console.log("La configuración de Sync ha cambiado. Recargando la extensión..."),this.initializeSync()):"local"===t&&e[this.storage.key]&&(console.log("El almacenamiento local ha cambiado. Recargando las carpetas."),this.folderManager.loadAndDisplayFolders())}handleMessage(e,t,a){"save_current_conversation_to_folder"===e.action&&this.folderManager.saveCurrentConversation(e.folderName)}}).init()})();