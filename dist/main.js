(()=>{"use strict";function e(e,t="info",a=3e3){const n=document.getElementById("gemini-organizer-toast-container");if(!n)return void console.error("Contenedor de toast no encontrado.");const r=document.createElement("div");r.classList.add("gemini-organizer-toast",`gemini-organizer-toast-${t}`),r.textContent=e,n.appendChild(r),r.offsetHeight,r.classList.add("show"),setTimeout(()=>{r.classList.remove("show"),r.addEventListener("transitionend",()=>{r.parentNode&&r.parentNode.removeChild(r)},{once:!0})},a)}function t(){try{const e=new URL(window.location.href).pathname.split("/"),t=e.pop()||e.pop();return t&&t.length>15?t:null}catch(e){return null}}async function a(e){const t=chrome.runtime.getURL(e);try{const e=await fetch(t);if(!e.ok)throw new Error(`Error al cargar el template: ${e.statusText}`);return await e.text()}catch(t){return console.error(`No se pudo obtener el template: ${e}`,t),""}}class n{constructor(){this.sidebar=null,this.toggleButton=null,this.activeSection=null}async initializeSidebar(){let e=document.getElementById("gemini-organizer-sidebar");return e||(e=document.createElement("div"),e.id="gemini-organizer-sidebar",e.classList.add("hidden"),e.innerHTML=await a("src/templates/sidebar.html")),this.sidebar=e,e}updateSyncStatusIcon(e){const t=document.getElementById("sync-status-icon");t&&(e?(t.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="cloud" fonticon="cloud"></mat-icon>',t.title="Carpetas sincronizadas con tu cuenta de Google."):(t.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="cloud_off" fonticon="cloud_off"></mat-icon>',t.title="Carpetas guardadas localmente en este dispositivo."))}async addToggleButton(e,t){const a=document.querySelector('side-nav-action-button[data-test-id="manage-instructions-control"]');if(a){let t=document.getElementById("gemini-organizer-wrapper");if(!t){t=document.createElement("side-nav-action-button"),t.id="gemini-organizer-wrapper",t.setAttribute("icon","folder_open"),t.setAttribute("arialabel","Organizador de Conversaciones"),t.setAttribute("data-test-id","gemini-organizer-button"),t.classList.add("mat-mdc-tooltip-trigger","ia-redesign","ng-star-inserted");const e=document.createElement("button");e.id="gemini-organizer-toggle-btn",e.classList.add("mat-mdc-list-item","mdc-list-item","side-nav-action-button","explicit-gmat-override","mat-mdc-list-item-interactive","mdc-list-item--with-leading-icon","mat-mdc-list-item-single-line","mdc-list-item--with-one-line","ng-star-inserted"),e.type="button",e.setAttribute("aria-label","Organizador de Conversaciones"),e.setAttribute("aria-disabled","false"),e.innerHTML='\n                    <div matlistitemicon="" class="mat-mdc-list-item-icon icon-container mdc-list-item__start" style="margin-left: 0px;margin-right: 0px;">\n                        <mat-icon role="img" class="mat-icon notranslate gds-icon-l google-symbols mat-ligature-font mat-icon-no-color ng-star-inserted" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="folder_open" fonticon="folder_open"></mat-icon>\n                    </div>\n                    <span class="mdc-list-item__content">\n                        <span class="mat-mdc-list-item-unscoped-content mdc-list-item__primary-text">\n                            <span data-test-id="side-nav-action-button-content" class="gds-body-m">Mis conversaciones</span>\n                        </span>\n                    </span>\n                    <div class="mat-focus-indicator"></div>\n                ',t.appendChild(e),a.after(t),this.toggleButton=e}this.sidebar||await this.initializeSidebar(),this.sidebar&&!t.contains(this.sidebar)&&t.appendChild(this.sidebar),e.addEventListeners()}}toggleSidebarVisibility(){this.sidebar&&(this.sidebar.classList.toggle("hidden"),this.sidebar.classList.contains("hidden")&&this.toggleSectionVisibility(null))}toggleSectionVisibility(e){const t=document.getElementById("create-folder-container"),a=document.getElementById("search-conversations-container"),n=document.getElementById("create-folder-section-btn"),r=document.getElementById("search-section-btn");this.activeSection===e&&(e=null),this.activeSection=e,t&&a&&(t.classList.toggle("hidden","create-folder-container"!==e),a.classList.toggle("hidden","search-conversations-container"!==e)),n&&r&&(n.classList.toggle("active","create-folder-container"===e),r.classList.toggle("active","search-conversations-container"===e))}async renderFolders(e,t,a,n){const r=document.getElementById("folders-list-ul");if(!r)return;r.innerHTML="";const i=Object.keys(e).sort();(await Promise.all(i.map(r=>{const i=e[r];return this.createFolderElement(r,i,t,a,n)}))).forEach(e=>r.appendChild(e))}async createFolderElement(e,t,a,n,r){const i=document.createElement("li");i.classList.add("gemini-folder-item");const o=await this.createFolderHeader(e,r),s=await this.createConversationsWrapper(e,t,n,r);i.appendChild(o),i.appendChild(s);const[d,l,c,g]=o.children;return n.addFolderInteractionListeners(o,s,g,l,c,e,d),a[e]?(s.classList.remove("hidden"),g.setAttribute("fonticon","expand_less"),g.setAttribute("data-mat-icon-name","expand_less")):(s.classList.add("hidden"),g.setAttribute("fonticon","expand_more"),g.setAttribute("data-mat-icon-name","expand_more")),i}async createFolderHeader(e,t){const n=document.createElement("div");n.classList.add("title-container"),n.setAttribute("role","button"),n.setAttribute("tabindex","0"),n.dataset.folderName=e,n.addEventListener("dragover",t.handleDragOver.bind(t)),n.addEventListener("dragleave",t.handleDragLeave.bind(t)),n.addEventListener("drop",t.handleDrop.bind(t));const r=await a("src/templates/folderHeader.html");return n.innerHTML=r.replace(/{{folderName}}/g,e),n}async createConversationsWrapper(e,t,a,n){const r=document.createElement("div");r.classList.add("conversations-list-wrapper");const i=document.createElement("ul");return i.classList.add("conversation-items-container","side-nav-opened"),i.dataset.folderName=e,i.addEventListener("dragover",n.handleConversationListDragOver.bind(n)),i.addEventListener("drop",n.handleConversationListDrop.bind(n)),(await Promise.all(t.map((t,r)=>this.createConversationElement(t,e,r,a,n)))).forEach(e=>i.appendChild(e)),r.appendChild(i),r}async createConversationElement(e,t,n,r,i){const o=document.createElement("li");o.classList.add("conversation-item-wrapper"),o.setAttribute("draggable","true"),o.dataset.folderName=t,o.dataset.convId=e.id,o.dataset.convTitle=e.title,o.dataset.convUrl=e.url,o.dataset.originalIndex=n,o.addEventListener("dragstart",i.handleDragStart.bind(i)),o.addEventListener("dragend",e=>e.target.classList.remove("is-dragging"));const s=await a("src/templates/conversationItem.html");return o.innerHTML=s.replace(/{{folderName}}/g,t).replace(/{{convId}}/g,e.id).replace(/{{convTitle}}/g,e.title),r.addConversationListeners(o),o}enableFolderEditMode(e,t,a,n,r,i){const o=e;t.style.display="none",a.style.display="none",n.style.display="none",r.style.display="none";const s=document.createElement("input");s.type="text",s.value=o,s.classList.add("folder-rename-input"),s.dataset.originalFolderName=o,t.parentNode.insertBefore(s,t),s.focus(),s.select(),i.addFolderRenameListeners(s,o,t,a,n,r)}openGeminiChat(t){const a=t.target.dataset.convId;if(a){const t='.chat-history-list .conversation[jslog*="\\"c_'+a+'\\""]',n=document.querySelector(t);if(n){const e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0,buttons:1}),t=new MouseEvent("mousedown",{view:window,bubbles:!0,cancelable:!0,buttons:1}),a=new MouseEvent("mouseup",{view:window,bubbles:!0,cancelable:!0});n.dispatchEvent(t),n.dispatchEvent(a),n.dispatchEvent(e),setTimeout(()=>{this.sidebar.classList.add("hidden")},100)}else e("No se pudo cargar la conversaci贸n r谩pidamente. Recargando p谩gina...","info"),window.location.href=`https://gemini.google.com/app/${a}`,this.sidebar.classList.add("hidden")}else e("No se pudo encontrar el ID de esta conversaci贸n.","error")}filterConversationsAndFolders(){const e=document.getElementById("search-conversations-input").value.toLowerCase().trim();document.getElementById("folders-list-ul").querySelectorAll(".gemini-folder-item").forEach(t=>{const a=t.querySelector(".gemini-folder-title").textContent.toLowerCase(),n=t.querySelector(".conversations-list-wrapper"),r=n.querySelectorAll(".conversation-item-wrapper"),i=t.querySelector(".gemini-expand-icon");let o=a.includes(e),s=!1;if(r.forEach(t=>{t.querySelector(".conversation-title").textContent.toLowerCase().includes(e)?(t.style.display="",s=!0):t.style.display="none"}),""===e)return t.style.display="",n.classList.add("hidden"),i.setAttribute("fonticon","expand_more"),i.setAttribute("data-mat-icon-name","expand_more"),void r.forEach(e=>e.style.display="");o||s?(t.style.display="",n.classList.remove("hidden"),i.setAttribute("fonticon","expand_less"),i.setAttribute("data-mat-icon-name","expand_less")):t.style.display="none"})}async displayFolderIndicator(e){const t=document.getElementById("gemini-organizer-folder-indicator");if(t&&t.remove(),!e)return;const a=await function(e,t=3e3){return new Promise(a=>{const n=Date.now();!function r(){const i=document.querySelector(e);i?a(i):Date.now()-n>t?a(null):requestAnimationFrame(r)}()})}('div[data-test-id="pillbox"]'),n=a?a.closest(".buttons-container"):null;if(!n)return void console.error("No se pudo encontrar el contenedor de botones (`.buttons-container`) para el indicador.");const r=document.createElement("div");r.id="gemini-organizer-folder-indicator",r.title=`Guardado en la carpeta: ${e}`,r.innerHTML=`\n            <mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" data-mat-icon-type="font" data-mat-icon-name="folder" fonticon="folder"></mat-icon>\n            <span>${e}</span>\n        `,n.prepend(r)}}class r{constructor(e){this.key=e,this.storageArea=null}async setStorageArea(e){return this.storageArea="sync"===e?chrome.storage.sync:chrome.storage.local,console.log("rea de almacenamiento establecida en: "+(this.storageArea===chrome.storage.sync?"sync":"local")),this}async getFolders(){return(await this.storageArea.get(this.key))[this.key]||{}}async saveFolders(e){return this.storageArea.set({[this.key]:e})}async getSyncEnabled(){return(await chrome.storage.sync.get("syncEnabled")).syncEnabled||!1}async setSyncEnabled(e){return chrome.storage.sync.set({syncEnabled:e})}}class i{constructor(e,t){this.storage=e,this.ui=t}async loadAndDisplayFolders(){const e=this.getOpenFolderStates(),t=await this.storage.getFolders();this.ui.renderFolders(t,e,this.eventHandler,this.dragAndDropHandler)}async createFolder(){const t=document.getElementById("new-folder-name"),a=t.value.trim();if(a){const n=await this.storage.getFolders();n[a]?e(`La carpeta "${a}" ya existe.`,"warning"):(n[a]=[],await this.storage.saveFolders(n),t.value="",e(`Carpeta "${a}" creada exitosamente.`,"success"))}else e("Por favor, ingresa un nombre para la carpeta.","warning")}async saveFolderRename(t,a,n,r,i,o){const s=t.value.trim();if(!t.parentNode)return;if(s===a)return t.remove(),n.style.display="block",r.style.display="block",i.style.display="block",void(o.style.display="block");if(!s)return e("El nombre de la carpeta no puede estar vac铆o. Se restaurar谩 el nombre original.","warning"),t.remove(),n.style.display="block",r.style.display="block",i.style.display="block",void(o.style.display="block");const d=await this.storage.getFolders();if(d[s]&&s!==a)return e(`Ya existe una carpeta con el nombre "${s}". Por favor, elige un nombre diferente.`,"warning"),t.remove(),n.style.display="block",r.style.display="block",i.style.display="block",void(o.style.display="block");const l=d[a];delete d[a],d[s]=l,await this.storage.saveFolders(d),e(`Carpeta "${a}" renombrada a "${s}" exitosamente.`,"success"),t.remove()}async deleteFolder(t){t.stopPropagation();const a=t.currentTarget.dataset.folderName;if(!a)return void e("Hubo un error al intentar eliminar la carpeta.","error");if(!confirm(`驴Est谩s seguro de que quieres eliminar la carpeta "${a}"?`))return;const n=await this.storage.getFolders();n[a]?(delete n[a],await this.storage.saveFolders(n),e(`Carpeta "${a}" eliminada.`,"success")):e("La carpeta especificada no existe.","error")}async deleteConversation(t){if(!confirm("驴Est谩s seguro de que quieres eliminar esta conversaci贸n?"))return;const a=t.currentTarget.dataset.folderName,n=t.currentTarget.dataset.convId;if(!a||!n)return void e("Hubo un error al intentar eliminar la conversaci贸n.","error");const r=await this.storage.getFolders();r[a]?(r[a]=r[a].filter(e=>e.id!==n),await this.storage.saveFolders(r),e("Conversaci贸n eliminada.","success")):e("La carpeta especificada no existe.","error")}getOpenFolderStates(){const e={},t=document.getElementById("folders-list-ul");return t&&t.querySelectorAll(".gemini-folder-item").forEach(t=>{const a=t.querySelector(".gemini-folder-title").dataset.folderName,n=t.querySelector(".conversations-list-wrapper");n&&!n.classList.contains("hidden")&&(e[a]=!0)}),e}async saveCurrentConversation(t){const a=window.location.href,n=extractRealConversationIdFromCurrentUrl(),r=extractConversationTitle();if(!n||!r)return void e("No se pudo obtener la informaci贸n de la conversaci贸n actual.","error");const i=await this.storage.getFolders();i[t]?i[t].find(e=>e.id===n)?e("Esta conversaci贸n ya est谩 guardada en esta carpeta.","info"):(i[t].push({id:n,title:r,url:a,timestamp:(new Date).toLocaleString()}),await this.storage.saveFolders(i),e(`Conversaci贸n guardada en la carpeta "${t}".`,"success")):e(`La carpeta "${t}" no existe.`,"error")}async findFolderForConversation(e){if(!e)return null;try{if(!chrome.runtime?.id)return console.warn("Gemini Organizer: Context invalidated, skipping folder check."),null;const t=await this.storage.getFolders();if(chrome.runtime.lastError)return console.warn("Gemini Organizer: Context invalidated during storage access.",chrome.runtime.lastError.message),null;for(const a in t)if(t[a].some(t=>t.id===e))return a;return null}catch(e){return console.warn("Gemini Organizer: Could not check for folder (context likely invalidated).",e.message),null}}setEventHandler(e){this.eventHandler=e}setDragAndDropHandler(e){this.dragAndDropHandler=e}}class o{constructor(e,t){this.storage=e,this.folderManager=t}handleDragStart(e){const a=e.target.closest('.chat-history-list .conversation[data-test-id="conversation"]'),n=e.target.closest('.conversation-item-wrapper[draggable="true"]');let r;if(a){const e=a.querySelector(".conversation-title"),n=e?e.textContent.trim():"Conversaci贸n sin t铆tulo";let i=null,o="";const s=a.getAttribute("jslog");if(s){const e=s.match(/BardVeMetadataKey:\[[^\]]*\x22c_([^\x22]+)\x22/);e&&e[1]&&(i=e[1],o=`https://gemini.google.com/app/${i}`)}!i&&a.classList.contains("selected")&&(i=t(),i&&(o=`https://gemini.google.com/app/${i}`)),i||(i="fallback_"+Date.now().toString()),r={id:i,title:n,url:o||window.location.href,folder_from:null,original_index:-1},a.classList.add("is-dragging")}else{if(!n)return void e.preventDefault();r={id:n.dataset.convId,title:n.dataset.convTitle,url:n.dataset.convUrl,folder_from:n.dataset.folderName,original_index:parseInt(n.dataset.originalIndex)},n.classList.add("is-dragging")}e.dataTransfer.setData("application/json",JSON.stringify(r)),e.dataTransfer.effectAllowed="move"}handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move",e.currentTarget&&e.currentTarget.classList.contains("title-container")&&e.currentTarget.classList.add("drag-over")}handleDragLeave(e){e.currentTarget&&e.currentTarget.classList.contains("title-container")&&e.currentTarget.classList.remove("drag-over"),e.currentTarget.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(e=>{e.classList.remove("drag-over-top","drag-over-bottom")})}async handleDrop(t){t.preventDefault(),t.currentTarget&&t.currentTarget.classList.contains("title-container")&&t.currentTarget.classList.remove("drag-over");const a=t.dataTransfer.getData("application/json");if(!a)return;const n=JSON.parse(a),r=t.currentTarget.dataset.folderName,i=n.folder_from;if(!r)return;const o=await this.storage.getFolders();i&&i!==r&&(o[i]=o[i].filter(e=>e.id!==n.id)),o[r].some(e=>e.id===n.id)||o[r].push({id:n.id,title:n.title,url:n.url,timestamp:(new Date).toLocaleString()}),await this.storage.saveFolders(o),e(`Conversaci贸n movida a "${r}"`,"success")}handleConversationListDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest(".conversation-item-wrapper"),a=e.currentTarget;if(a.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(e=>e.classList.remove("drag-over-top","drag-over-bottom")),t){const a=t.getBoundingClientRect();e.clientY-a.top<a.height/2?t.classList.add("drag-over-top"):t.classList.add("drag-over-bottom")}else a.classList.add("drag-over-bottom")}async handleConversationListDrop(t){t.preventDefault(),t.currentTarget.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(e=>e.classList.remove("drag-over-top","drag-over-bottom"));const a=t.dataTransfer.getData("application/json");if(!a)return;const n=JSON.parse(a),r=t.currentTarget.dataset.folderName,i=n.folder_from,o=n.original_index;if(!r)return;const s=await this.storage.getFolders(),d=t.target.closest(".conversation-item-wrapper");let l;if(d){const e=d.getBoundingClientRect(),a=t.clientY-e.top,n=Array.from(d.parentNode.children).indexOf(d);l=a<e.height/2?n:n+1}else l=s[r].length;if(i===r){const[e]=s[r].splice(o,1);s[r].splice(l>o?l-1:l,0,e)}else i&&(s[i]=s[i].filter(e=>e.id!==n.id)),s[r].some(e=>e.id===n.id)||s[r].splice(l,0,{id:n.id,title:n.title,url:n.url,timestamp:(new Date).toLocaleString()});await this.storage.saveFolders(s),e("Conversaci贸n reordenada","success")}async setupDraggableConversations(){const e=document.querySelectorAll('.chat-history-list .conversation[data-test-id="conversation"]'),t=await this.storage.getFolders(),a=new Set;for(const e in t)t[e].forEach(e=>a.add(e.id));e.forEach(e=>{e.hasAttribute("data-draggable-setup")||(e.setAttribute("draggable","true"),e.addEventListener("dragstart",this.handleDragStart.bind(this)),e.addEventListener("dragend",e=>e.target.classList.remove("is-dragging")),e.setAttribute("data-draggable-setup","true"));const t=e.getAttribute("jslog");let n=null;if(t){const e=t.match(/BardVeMetadataKey:\[[^\]]*\x22c_([^\x22]+)\x22/);e&&e[1]&&(n=e[1])}const r=e.querySelector(".conversation-title");if(n&&a.has(n)){e.classList.add("is-saved");let t=r.querySelector(".gemini-organizer-saved-icon");t||(t=document.createElement("span"),t.classList.add("gemini-organizer-saved-icon"),t.textContent="",r.insertBefore(t,r.firstChild))}else{e.classList.remove("is-saved");const t=r.querySelector(".gemini-organizer-saved-icon");t&&t.remove()}})}}class s{constructor(e,t,a){this.ui=e,this.folderManager=t,this.dragAndDropHandler=a}addEventListeners(){const e=document.getElementById("create-folder-section-btn");e&&e.addEventListener("click",()=>this.ui.toggleSectionVisibility("create-folder-container"));const t=document.getElementById("search-section-btn");t&&t.addEventListener("click",()=>this.ui.toggleSectionVisibility("search-conversations-container"));const a=document.getElementById("create-folder-btn");a&&a.addEventListener("click",this.folderManager.createFolder.bind(this.folderManager));const n=document.getElementById("search-conversations-input");n&&n.addEventListener("input",this.ui.filterConversationsAndFolders.bind(this.ui)),this.ui.toggleButton&&this.ui.toggleButton.addEventListener("click",this.ui.toggleSidebarVisibility.bind(this.ui))}addFolderInteractionListeners(e,t,a,n,r,i,o){e.addEventListener("click",()=>{t.classList.toggle("hidden");const e=t.classList.contains("hidden");a.setAttribute("fonticon",e?"expand_more":"expand_less"),a.setAttribute("data-mat-icon-name",e?"expand_more":"expand_less")}),n.addEventListener("click",e=>{e.stopPropagation(),this.ui.enableFolderEditMode(i,o,r,n,a,this)}),r.addEventListener("click",this.folderManager.deleteFolder.bind(this.folderManager))}addFolderRenameListeners(e,t,a,n,r,i){e.addEventListener("keypress",o=>{"Enter"===o.key&&this.folderManager.saveFolderRename(e,t,a,n,r,i)}),e.addEventListener("blur",()=>{this.folderManager.saveFolderRename(e,t,a,n,r,i)})}addConversationListeners(e){const t=e.querySelector(".conversation-title");t&&t.addEventListener("click",this.ui.openGeminiChat.bind(this.ui));const a=e.querySelector(".delete-conversation-btn");a&&a.addEventListener("click",this.folderManager.deleteConversation.bind(this.folderManager))}}(new class{constructor(){this.ui=new n,this.storage=new r("geminiConversations"),this.folderManager=new i(this.storage,this.ui),this.dragAndDropHandler=new o(this.storage,this.folderManager),this.eventHandler=new s(this.ui,this.folderManager,this.dragAndDropHandler),this.folderManager.setEventHandler(this.eventHandler),this.folderManager.setDragAndDropHandler(this.dragAndDropHandler),this.observer=new MutationObserver(this.handleMutations.bind(this)),chrome.storage.onChanged.addListener(this.handleStorageChange.bind(this)),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),this.lastUrl=window.location.href}async init(){if(!document.getElementById("gemini-organizer-toast-container")){const e=document.createElement("div");e.id="gemini-organizer-toast-container",document.body.appendChild(e)}await this.initializeSync(),await this.updateFolderIndicator(),window.requestIdleCallback(async()=>{await this.ui.addToggleButton(this.eventHandler,this.folderManager),this.dragAndDropHandler.setupDraggableConversations(),this.observer.observe(document.body,{childList:!0,subtree:!0})})}async initializeSync(){const e=await this.storage.getSyncEnabled();await this.storage.setStorageArea(e?"sync":"local"),await this.folderManager.loadAndDisplayFolders(),setTimeout(async()=>{this.ui.sidebar||await this.ui.initializeSidebar(),this.ui.updateSyncStatusIcon(e);const t=document.getElementById("open-options-btn");t&&t.addEventListener("click",()=>{chrome.runtime.sendMessage({action:"openOptionsPage"})})},500)}async handleMutations(){const e=document.getElementById("gemini-organizer-wrapper");e&&document.body.contains(e)||(await this.ui.addToggleButton(this.eventHandler,this.folderManager),await this.initializeSync()),this.dragAndDropHandler.setupDraggableConversations(),window.location.href!==this.lastUrl&&(this.lastUrl=window.location.href,await this.updateFolderIndicator())}async updateFolderIndicator(){try{const e=function(){const e=document.querySelector(".conversation.selected");if(e){const t=e.getAttribute("jslog");if(t){const e=t.match(/BardVeMetadataKey:\[[^\]]*\\x22c_([^\x22]+)\\x22/);if(e&&e[1])return e[1]}}return t()}(),a=await this.folderManager.findFolderForConversation(e);await this.ui.displayFolderIndicator(a)}catch(e){console.error("Error al actualizar el indicador de carpeta:",e),this.ui.displayFolderIndicator(null)}}handleStorageChange(e,t){"sync"===t&&(e.syncEnabled||e[this.storage.key])?(console.log("La configuraci贸n de Sync ha cambiado. Recargando la extensi贸n..."),this.initializeSync()):"local"===t&&e[this.storage.key]&&(console.log("El almacenamiento local ha cambiado. Recargando las carpetas."),this.folderManager.loadAndDisplayFolders())}handleMessage(e,t,a){"save_current_conversation_to_folder"===e.action&&this.folderManager.saveCurrentConversation(e.folderName)}}).init()})();